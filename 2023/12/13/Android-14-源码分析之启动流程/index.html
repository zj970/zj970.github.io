<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android_14_源码分析之启动流程 | 落雪のBlog</title><meta name="author" content="zj970"><meta name="copyright" content="zj970"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前序  &amp;emsp;&amp;emsp;时间从来不语，却回答了所有问题，岁月从来不言，却见证了所有努力，愿大家遇到困难时都能换乘机遇，踏歌而行时一往无前。 参考资料 Android Framework 开发揭秘  &amp;emsp;&amp;emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ 简介&amp;emsp;&amp;emsp;Android 是一种基于 Linu">
<meta property="og:type" content="article">
<meta property="og:title" content="Android_14_源码分析之启动流程">
<meta property="og:url" content="https://www.serendipity.fit/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="落雪のBlog">
<meta property="og:description" content="前序  &amp;emsp;&amp;emsp;时间从来不语，却回答了所有问题，岁月从来不言，却见证了所有努力，愿大家遇到困难时都能换乘机遇，踏歌而行时一往无前。 参考资料 Android Framework 开发揭秘  &amp;emsp;&amp;emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ 简介&amp;emsp;&amp;emsp;Android 是一种基于 Linu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp">
<meta property="article:published_time" content="2023-12-12T16:39:12.000Z">
<meta property="article:modified_time" content="2025-09-13T18:20:19.415Z">
<meta property="article:author" content="zj970">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Android_14_源码分析之启动流程",
  "url": "https://www.serendipity.fit/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/",
  "image": "https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp",
  "datePublished": "2023-12-12T16:39:12.000Z",
  "dateModified": "2025-09-13T18:20:19.415Z",
  "author": [
    {
      "@type": "Person",
      "name": "zj970",
      "url": "https://www.serendipity.fit"
    }
  ]
}</script><link rel="shortcut icon" href="https://gitee.com/zhou-jian1234/resource/raw/master/paper/favicon.webp"><link rel="canonical" href="https://www.serendipity.fit/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android_14_源码分析之启动流程',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/zj970/resource/personal/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">落雪のBlog</span></a><a class="nav-page-title" href="/"><span class="site-name">Android_14_源码分析之启动流程</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Android_14_源码分析之启动流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-12T16:39:12.000Z" title="发表于 2023-12-13 00:39:12">2023-12-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-13T18:20:19.415Z" title="更新于 2025-09-14 02:20:19">2025-09-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><meta name="referrer" content="no-referrer"/>

<ul>
<li>前序</li>
</ul>
<p>&emsp;&emsp;时间从来不语，却回答了所有问题，岁月从来不言，却见证了所有努力，愿大家遇到困难时都能换乘机遇，踏歌而行时一往无前。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>Android Framework 开发揭秘</li>
</ul>
<p>&emsp;&emsp;<font color=red>本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！</font></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>&emsp;&emsp;Android 是一种基于 Linux 的开放源代码软件栈，为各类设备和机型而创建。</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://developer.android.google.cn/static/guide/platform/images/android-stack_2x.png?hl=zh-cn" alt="平台架构.png"></p>
<p>&emsp;&emsp;Android 平台的基础是Linux内核。例如，Android Runtime(ART)依靠Linux内核来执行底层功能，例如线程和底层内存管理。</p>
<h2 id="Linux-内核"><a href="#Linux-内核" class="headerlink" title="Linux 内核"></a>Linux 内核</h2><ul>
<li><p>硬件抽象层(HAL)</p>
<ul>
<li>HAL提供标准界面，向更高级的Java API 框架显示设备硬件功能。</li>
</ul>
</li>
<li><p>Android Runtime</p>
<ul>
<li>对于运行在Android 5.5(API 21)以上的设备，每个应用都有自己的ART实例并在其自己的进程中运行。</li>
<li>ART编写为通过执行DEX文件在低内存上运行多个虚拟机。</li>
<li>ART的功能包括<ul>
<li>预先AOT和及时JIT，编译优化而垃圾回收GC</li>
<li>在API 28以上，支持将应用软件包中的Dalvik Executable格式(DEX)文件转换为更紧凑的机器代码。</li>
</ul>
</li>
</ul>
</li>
<li><p>原生C&#x2F;C++库</p>
</li>
<li><p>Java API框架</p>
</li>
</ul>
<h2 id="Android-系统启动的大概流程"><a href="#Android-系统启动的大概流程" class="headerlink" title="Android 系统启动的大概流程"></a>Android 系统启动的大概流程</h2><ol>
<li>启动电源以及系统启动：当电源按下，引导芯片代码开始从预定义的地方(固化在ROM硬盘)开始执行。加载引导程序到RAM内存。<font color=red>Boot ROM</font></li>
<li>引导程序：引导程序是在Android操作系统开始运行前的程序，针对特定主板和芯片。比如redboot、uboot、qibootloader或者其他。android引导程序可以在.&#x2F;bootable找到。</li>
<li>内核：Android内核与桌面linux内核启动方式差不多。内核启动时读取配置文件，设置缓存，被保护存储器、计划列表，加载驱动，当内核完成系统设置，它首先在系统文件中找”init”文件，然后启动root进程或者系统的第一个进程。</li>
<li>init进程：init进程是系统所有进程的起点，进程号固定为1。Kernel启动后，在用户空间启动init进程，并调用init中的main()方法进行init进程的职责。</li>
<li>启动Lancher App</li>
</ol>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
    graph TB
    Boot[Boot ROM] --&gt; Lader[Boot Loader]
    Lader --&gt; Kernel[Kernel]
    Kernel --&gt; init[init进程pid&#x3D;1]
    init --&gt; Zygote[Zygote进程_Android Runtime_C++Framework Native]
    Zygote --&gt; Server[启动必要的System Server]
    
    Server --&gt; launcher[桌面应用Launcher]
  </pre></div>

<h3 id="init进程分析"><a href="#init进程分析" class="headerlink" title="init进程分析"></a>init进程分析</h3><p>&emsp;&emsp;init进程是Android 系统中及其重要的第一个进程</p>
<ol>
<li>创建和挂载启动所需要的文件目录</li>
<li>初始化和启动属性服务</li>
<li>解析init.rc配置文件并启动Zygote进程</li>
</ol>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
    graph TB
    init[init] --&gt; zygote[zygote]
    init --&gt; servicemanager[servicemanager]
    zygote -..-&gt; system_server[system_servre]  
    servicemanager -..-&gt; system_server  
    system_server -..-&gt; app[app]

  </pre></div>

<ul>
<li>system&#x2F;core&#x2F;init&#x2F;main.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果编译时开启了 AddressSanitizer，则设置地址检测器错误报告回调函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __has_feature(address_sanitizer)</span></span><br><span class="line">    __asan_set_error_report_callback(AsanReportCallback);</span><br><span class="line"><span class="comment">// 如果编译时开启了 HardwareAddressSanitizer，则设置硬件地址检测器错误报告回调函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> __has_feature(hwaddress_sanitizer)</span></span><br><span class="line">    __hwasan_set_error_report_callback(AsanReportCallback);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提高进程优先级，稍后会恢复</span></span><br><span class="line">    setpriority(PRIO_PROCESS, <span class="number">0</span>, <span class="number">-20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果可执行文件的基本名称（去掉路径部分）是 &quot;ueventd&quot;，则调用 ueventd_main 函数</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">&quot;ueventd&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果命令行参数个数大于 1</span></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果第一个参数是 &quot;subcontext&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;subcontext&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 初始化日志系统，并调用 SubcontextMain 函数</span></span><br><span class="line">            android::base::InitLogging(argv, &amp;android::base::KernelLogger);</span><br><span class="line">            <span class="type">const</span> BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SubcontextMain(argc, argv, &amp;function_map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果第一个参数是 &quot;selinux_setup&quot;，则调用 SetupSelinux 函数</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;selinux_setup&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> SetupSelinux(argv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果第一个参数是 &quot;second_stage&quot;，则调用 SecondStageMain 函数</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;second_stage&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> SecondStageMain(argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认情况下调用 FirstStageMain 函数</span></span><br><span class="line">    <span class="keyword">return</span> FirstStageMain(argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;后续在FirstStageMain()函数中mount挂载文件系统，创建一系列文件，以及初始化目录的读写权限，并创建设备文件，位于.&#x2F;first_stage_main.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">FirstStageMain</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line"><span class="comment">// InstallRebootSignalHandlers 用于在发生 panic 时重新启动到 bootloader，如果已配置。</span></span><br><span class="line"><span class="keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;</span><br><span class="line">    InstallRebootSignalHandlers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录启动时间，使用 boot_clock。</span></span><br><span class="line">boot_clock::time_point start_time = boot_clock::now();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储初始化过程中遇到的错误的向量。</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="type">int</span>&gt;&gt; errors;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CHECKCALL 宏用于检查系统调用的结果，并将任何错误添加到 &#x27;errors&#x27; 向量中。</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECKCALL(x) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((x) != 0) errors.emplace_back(#x <span class="string">&quot; 失败&quot;</span>, errno);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 umask 设置为 0。</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除环境变量。</span></span><br><span class="line">CHECKCALL(clearenv());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 PATH 环境变量设置为默认路径。</span></span><br><span class="line">CHECKCALL(setenv(<span class="string">&quot;PATH&quot;</span>, _PATH_DEFPATH, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载必要的文件系统并创建基本目录。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 vold 管理的设备挂载分区的暂存区域。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">CHECKCALL(mount(<span class="string">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class="string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,</span><br><span class="line">                <span class="string">&quot;mode=0755,uid=0,gid=0&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置错误检查宏。</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> CHECKCALL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将标准输入、输出和错误重定向到 /dev/null。</span></span><br><span class="line">SetStdioToDevNull(argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化内核日志。</span></span><br><span class="line">InitKernelLogging(argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果初始化过程中遇到错误，记录错误信息。</span></span><br><span class="line"><span class="keyword">if</span> (!errors.empty()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [error_string, error_errno] : errors) &#123;</span><br><span class="line">        LOG(ERROR) &lt;&lt; error_string &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; strerror(error_errno);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG(FATAL) &lt;&lt; <span class="string">&quot;Init 在启动第一阶段时遇到错误，中止&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录第一阶段启动的消息。</span></span><br><span class="line">LOG(INFO) &lt;&lt; <span class="string">&quot;init 第一阶段启动！&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果需要，释放 ramdisk。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 确定是否启用 console，并检查是否请求并行模块加载。</span></span><br><span class="line"><span class="keyword">auto</span> want_console = ALLOW_FIRST_STAGE_CONSOLE ? FirstStageConsole(cmdline, bootconfig) : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> want_parallel = bootconfig.find(<span class="string">&quot;androidboot.load_modules_parallel = \&quot;true\&quot;&quot;</span>) != <span class="built_in">std</span>::<span class="built_in">string</span>::npos;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载内核模块。</span></span><br><span class="line"><span class="type">int</span> module_count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LoadKernelModules(IsRecoveryMode() &amp;&amp; !ForceNormalBoot(cmdline, bootconfig), want_console,</span><br><span class="line">                  want_parallel, module_count);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印有关加载的内核模块的信息。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果启用失败时的 console，创建设备。</span></span><br><span class="line"><span class="type">bool</span> created_devices = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (want_console == FirstStageConsoleParam::CONSOLE_ON_FAILURE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!IsRecoveryMode()) &#123;</span><br><span class="line">        created_devices = DoCreateDevices();</span><br><span class="line">        <span class="keyword">if</span> (!created_devices) &#123;</span><br><span class="line">            LOG(ERROR) &lt;&lt; <span class="string">&quot;无法提前创建设备节点&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    StartConsole(cmdline);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果存在 ramdisk prop，则复制。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置环境变量，以便第二阶段 init 读取调试文件。</span></span><br><span class="line">setenv(<span class="string">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>, <span class="string">&quot;true&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果强制正常启动，则切换根目录。</span></span><br><span class="line"><span class="keyword">if</span> (ForceNormalBoot(cmdline, bootconfig)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    SwitchRoot(<span class="string">&quot;/first_stage_ramdisk&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行第一阶段挂载。</span></span><br><span class="line"><span class="keyword">if</span> (!DoFirstStageMount(!created_devices)) &#123;</span><br><span class="line">    LOG(FATAL) &lt;&lt; <span class="string">&quot;无法提前挂载所需的分区...&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果存在旧的 ramdisk，则释放它。</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果需要，在 recovery 中设置 AVB 版本。</span></span><br><span class="line">SetInitAvbVersionInRecovery();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置环境变量以记录启动时间。</span></span><br><span class="line">setenv(kEnvFirstStageStartedAt, <span class="built_in">std</span>::to_string(start_time.time_since_epoch().count()).c_str(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 execv() 替换当前进程为第二阶段 init。</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* path = <span class="string">&quot;/system/bin/init&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* args[] = &#123;path, <span class="string">&quot;selinux_setup&quot;</span>, nullptr&#125;;</span><br><span class="line"><span class="keyword">auto</span> fd = open(<span class="string">&quot;/dev/kmsg&quot;</span>, O_WRONLY | O_CLOEXEC);</span><br><span class="line">dup2(fd, STDOUT_FILENO);</span><br><span class="line">dup2(fd, STDERR_FILENO);</span><br><span class="line">close(fd);</span><br><span class="line">execv(path, const_cast&lt;<span class="type">char</span>**&gt;(args));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果发生错误，execv() 只有在发生错误时才返回。</span></span><br><span class="line">PLOG(FATAL) &lt;&lt; <span class="string">&quot;execv(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;) 失败&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="init-rc-解析"><a href="#init-rc-解析" class="headerlink" title="init.rc 解析"></a>init.rc 解析</h3><ul>
<li>路径:system&#x2F;core&#x2F;rootdir&#x2F;init.rc</li>
</ul>
<p>&emsp;&emsp;init.rc 是一个非常重要的配置文件，由Android初始化语言(Android Init Language)编写的脚本，它主要包含五种类型语句：Action(Action中包含了一系列的Command)、Commands(init语言中的命令)、Service(由init进程启动的服务)、Options(对服务进行配置的选项)和Import(引入其他配置文件)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">## line 490</span><br><span class="line">on property:apexd.status=ready &amp;&amp; property:ro.product.cpu.abilist64=*</span><br><span class="line">    exec_start boringssl_self_test_apex64</span><br><span class="line"></span><br><span class="line">service boringssl_self_test32 /system/bin/boringssl_self_test32</span><br><span class="line">    reboot_on_failure reboot,boringssl-self-check-failed</span><br><span class="line">    stdio_to_kmsg</span><br><span class="line">    # Explicitly specify that boringssl_self_test32 doesn&#x27;t require any capabilities</span><br><span class="line">    capabilities</span><br><span class="line">    user nobody</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure>

<ul>
<li>语法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">on  &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]* //设置触发器</span><br><span class="line">    &lt;command&gt;</span><br><span class="line">    &lt;command&gt; //动作触发之后要执行的命令</span><br><span class="line"></span><br><span class="line">service &lt;name&gt; &lt;pathname&gt; [&lt;argument&gt;]* //&lt;service的名字&gt;&lt;执行程序路径&gt;&lt;传递参数&gt;</span><br><span class="line">    &lt;option&gt; //options是services的参数配置，它们影响Service如何运行及运行时机</span><br><span class="line">    group &lt;groupname&gt; [&lt;groupname&gt;\*] //在启动Service前将group改为第一个groupname,第一个groupname是必须有的</span><br><span class="line">    //默认值是root，第二各groupname可以不设置，用于追加组(通过setgroups)</span><br><span class="line">    priority &lt;proiority&gt; //设置进程优先级，在-20~19之间，默认值是0,通过setpriority实现</span><br><span class="line">    socket &lt;name&gt; &lt;type&gt; &lt;perm&gt; [&lt;user&gt; [&lt;group&gt; [&lt;seclabel&gt;]]] //创建一个unix域的socket,名字叫/dev/socket/name,并将fd返回给Service,type只能是dgram,stream,swqpacket</span><br></pre></td></tr></table></figure>

<h4 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h4><p>&emsp;&emsp;Action通过触发器trigger，即以on开头的语句来决定执行相应的service的时机。具体有如下时机：</p>
<ul>
<li>on early-init：在初始化早期阶段触发</li>
<li>on init：在初始化阶段触发</li>
<li>on late-init：在初始化晚期阶段触发</li>
<li>on boot&#x2F;charger：当系统启动&#x2F;充电时触发</li>
<li>on property：&#x3D;：当属性值满足条件时触发</li>
</ul>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p>&emsp;&emsp;服务Service，以service开头，由init进程启动，一般运行在init的一个子进程，所以启动service前需要判断对应的可执行文件是否存在。init生成的子进程，定义在rc文件，其中每一个service在启动时会通过fork方式生成子进程。例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service boringssl_self_test32 /system/bin/boringssl_self_test32</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;代表的是服务名为boringssl_self_test32，服务执行的路径为&#x2F;system&#x2F;bin&#x2F;boringssl_self_test32</p>
<h4 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h4><ul>
<li>class_start <service_class_name>: 启动属于同一个class的所有服务</li>
<li>start <service_name>：启动指定的服务，若已启动则跳过</li>
<li>stop <service_name>：停止正在运行的服务</li>
<li>setprop：设置属性值</li>
<li>mkdir：创建指定目录</li>
<li>symlink <sym_link>：创建连接到的<sym_link>符号链接</li>
<li>write：向文件path中写入字符串</li>
<li>exec：fork并执行，会阻塞init进程直到程序完毕</li>
<li>exprot：设定环境变量</li>
<li>loglevel：设定log级别</li>
</ul>
<h4 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h4><p>&emsp;&emsp;Options是Service的可选项，与service配合使用</p>
<ul>
<li><p>disabled：不随class自动启动，只有根据Service名才启动</p>
</li>
<li><p>oneshot：service退出后不再重启</p>
</li>
<li><p>user&#x2F;group：设置执行服务的用户&#x2F;用户组，默认都是root；</p>
</li>
<li><p>class：设置所属的类名，当所属类启动&#x2F;退出时，服务也启动&#x2F;停止，默认为default;onrestart：当服务重启时执行相应命令</p>
</li>
<li><p>socket：创建名为&#x2F;dev&#x2F;socket&#x2F;<name>的socket,critical：在规定时间内该Service不断重启，则系统会重启并进入恢复模式 default:意味着disabled&#x3D;flase,oneshot&#x3D;false,critical&#x3D;false</p>
</li>
<li><p>system&#x2F;core&#x2F;rootdir&#x2F;init.zygote64.rc</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    socket usap_pool_primary stream 660 root system</span><br><span class="line">    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    # NOTE: If the wakelock name here is changed, then also</span><br><span class="line">    # update it in SystemSuspend.cpp</span><br><span class="line">    onrestart write /sys/power/wake_lock zygote_kwl</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart media.tuner</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    task_profiles ProcessCapacityHigh MaxPerformance</span><br><span class="line">    critical window=$&#123;zygote.critical_window.minute:-off&#125; target=zygote-fatal</span><br></pre></td></tr></table></figure>

<h4 id="service解析流程"><a href="#service解析流程" class="headerlink" title="service解析流程"></a>service解析流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 337</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">LoadBootScripts</span><span class="params">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> &#123;</span><br><span class="line">    Parser parser = CreateParser(action_manager, service_list);<span class="comment">//创建解析器</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> bootscript = GetProperty(<span class="string">&quot;ro.boot.init_rc&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (bootscript.empty()) &#123;</span><br><span class="line">        parser.ParseConfig(<span class="string">&quot;/system/etc/init/hw/init.rc&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">&quot;/system/etc/init&quot;</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">&quot;/system/etc/init&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// late_import is available only in Q and earlier release. As we don&#x27;t</span></span><br><span class="line">        <span class="comment">// have system_ext in those versions, skip late_import for system_ext.</span></span><br><span class="line">        parser.ParseConfig(<span class="string">&quot;/system_ext/etc/init&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">&quot;/vendor/etc/init&quot;</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">&quot;/vendor/etc/init&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">&quot;/odm/etc/init&quot;</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">&quot;/odm/etc/init&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parser.ParseConfig(<span class="string">&quot;/product/etc/init&quot;</span>)) &#123;</span><br><span class="line">            late_import_paths.emplace_back(<span class="string">&quot;/product/etc/init&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parser.ParseConfig(bootscript);<span class="comment">//开始解析</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Line 270</span></span><br><span class="line"></span><br><span class="line">Parser <span class="title function_">CreateParser</span><span class="params">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> &#123;</span><br><span class="line">    Parser parser;</span><br><span class="line"></span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;service&quot;</span>, <span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;(</span><br><span class="line">                                               &amp;service_list, GetSubcontext(), <span class="built_in">std</span>::nullopt));<span class="comment">//service解析</span></span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;on&quot;</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;(&amp;action_manager, GetSubcontext()));</span><br><span class="line">    parser.AddSectionParser(<span class="string">&quot;import&quot;</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;(&amp;parser));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parser;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>system&#x2F;core&#x2F;init&#x2F;parser.cpp</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">void Parser::ParseData(const std::string&amp; filename, std::string* data) &#123;</span><br><span class="line">    data-&gt;push_back(&#x27;\n&#x27;);</span><br><span class="line">    data-&gt;push_back(&#x27;\0&#x27;);</span><br><span class="line"></span><br><span class="line">    parse_state state;</span><br><span class="line">    state.line = 0;</span><br><span class="line">    state.ptr = data-&gt;data();</span><br><span class="line">    state.nexttoken = 0;</span><br><span class="line"></span><br><span class="line">    SectionParser* section_parser = nullptr;</span><br><span class="line">    int section_start_line = -1;</span><br><span class="line">    std::vector&lt;std::string&gt; args;</span><br><span class="line"></span><br><span class="line">    // If we encounter a bad section start, there is no valid parser object to parse the subsequent</span><br><span class="line">    // sections, so we must suppress errors until the next valid section is found.</span><br><span class="line">    bool bad_section_found = false;</span><br><span class="line"></span><br><span class="line">    auto end_section = [&amp;] &#123;</span><br><span class="line">        bad_section_found = false;</span><br><span class="line">        if (section_parser == nullptr) return;</span><br><span class="line"></span><br><span class="line">        if (auto result = section_parser-&gt;EndSection(); !result.ok()) &#123;</span><br><span class="line">            parse_error_count_++;</span><br><span class="line">            LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; section_start_line &lt;&lt; &quot;: &quot; &lt;&lt; result.error();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        section_parser = nullptr;</span><br><span class="line">        section_start_line = -1;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        switch (next_token(&amp;state)) &#123;</span><br><span class="line">            case T_EOF:</span><br><span class="line">                end_section();</span><br><span class="line"></span><br><span class="line">                for (const auto&amp; [section_name, section_parser] : section_parsers_) &#123;</span><br><span class="line">                    section_parser-&gt;EndFile();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return;</span><br><span class="line">            case T_NEWLINE: &#123;</span><br><span class="line">                state.line++;</span><br><span class="line">                if (args.empty()) break;</span><br><span class="line">                // If we have a line matching a prefix we recognize, call its callback and unset any</span><br><span class="line">                // current section parsers.  This is meant for /sys/ and /dev/ line entries for</span><br><span class="line">                // uevent.</span><br><span class="line">                auto line_callback = std::find_if(</span><br><span class="line">                    line_callbacks_.begin(), line_callbacks_.end(),</span><br><span class="line">                    [&amp;args](const auto&amp; c) &#123; return android::base::StartsWith(args[0], c.first); &#125;);</span><br><span class="line">                if (line_callback != line_callbacks_.end()) &#123;</span><br><span class="line">                    end_section();</span><br><span class="line"></span><br><span class="line">                    if (auto result = line_callback-&gt;second(std::move(args)); !result.ok()) &#123;</span><br><span class="line">                        parse_error_count_++;</span><br><span class="line">                        LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line &lt;&lt; &quot;: &quot; &lt;&lt; result.error();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (section_parsers_.count(args[0])) &#123;</span><br><span class="line">                    end_section();</span><br><span class="line">                    section_parser = section_parsers_[args[0]].get();</span><br><span class="line">                    section_start_line = state.line;</span><br><span class="line">                    if (auto result =</span><br><span class="line">                                section_parser-&gt;ParseSection(std::move(args), filename, state.line);</span><br><span class="line">                        !result.ok()) &#123;</span><br><span class="line">                        parse_error_count_++;</span><br><span class="line">                        LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line &lt;&lt; &quot;: &quot; &lt;&lt; result.error();</span><br><span class="line">                        section_parser = nullptr;</span><br><span class="line">                        bad_section_found = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (section_parser) &#123;</span><br><span class="line">                    if (auto result = section_parser-&gt;ParseLineSection(std::move(args), state.line);</span><br><span class="line">                        !result.ok()) &#123;</span><br><span class="line">                        parse_error_count_++;</span><br><span class="line">                        LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line &lt;&lt; &quot;: &quot; &lt;&lt; result.error();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (!bad_section_found) &#123;</span><br><span class="line">                    parse_error_count_++;</span><br><span class="line">                    LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line</span><br><span class="line">                               &lt;&lt; &quot;: Invalid section keyword found&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                args.clear();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case T_TEXT:</span><br><span class="line">                args.emplace_back(state.text);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>system&#x2F;core&#x2F;init&#x2F;service.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">Result&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Service&gt;&gt; Service::MakeTemporaryOneshotService(</span><br><span class="line">        <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args) &#123;</span><br><span class="line">    <span class="comment">// Parse the arguments: exec [SECLABEL [UID [GID]*] --] COMMAND ARGS...</span></span><br><span class="line">    <span class="comment">// SECLABEL can be a - to denote default</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="type">size_t</span> command_arg = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="type">size_t</span> i = <span class="number">1</span>; i &lt; args.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args[i] == <span class="string">&quot;--&quot;</span>) &#123;</span><br><span class="line">            command_arg = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (command_arg &gt; <span class="number">4</span> + NR_SVC_SUPP_GIDS) &#123;</span><br><span class="line">        <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;exec called with too many supplementary group ids&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (command_arg &gt;= args.size()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;exec called without command&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="title function_">str_args</span><span class="params">(args.begin() + command_arg, args.end())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> exec_count = <span class="number">0</span>;</span><br><span class="line">    exec_count++;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> name = <span class="string">&quot;exec &quot;</span> + <span class="built_in">std</span>::to_string(exec_count) + <span class="string">&quot; (&quot;</span> + Join(str_args, <span class="string">&quot; &quot;</span>) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> flags = SVC_ONESHOT | SVC_TEMPORARY;</span><br><span class="line">    <span class="type">unsigned</span> namespace_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> seclabel = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (command_arg &gt; <span class="number">2</span> &amp;&amp; args[<span class="number">1</span>] != <span class="string">&quot;-&quot;</span>) &#123;</span><br><span class="line">        seclabel = args[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    Result&lt;<span class="type">uid_t</span>&gt; uid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (command_arg &gt; <span class="number">3</span>) &#123;</span><br><span class="line">        uid = DecodeUid(args[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!uid.ok()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;Unable to decode UID for &#x27;&quot;</span> &lt;&lt; args[<span class="number">2</span>] &lt;&lt; <span class="string">&quot;&#x27;: &quot;</span> &lt;&lt; uid.error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Result&lt;<span class="type">gid_t</span>&gt; gid = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">gid_t</span>&gt; supp_gids;</span><br><span class="line">    <span class="keyword">if</span> (command_arg &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        gid = DecodeUid(args[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!gid.ok()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;Unable to decode GID for &#x27;&quot;</span> &lt;&lt; args[<span class="number">3</span>] &lt;&lt; <span class="string">&quot;&#x27;: &quot;</span> &lt;&lt; gid.error();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="type">size_t</span> nr_supp_gids = command_arg - <span class="number">1</span> <span class="comment">/* -- */</span> - <span class="number">4</span> <span class="comment">/* exec SECLABEL UID GID */</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; nr_supp_gids; ++i) &#123;</span><br><span class="line">            <span class="keyword">auto</span> supp_gid = DecodeUid(args[<span class="number">4</span> + i]);</span><br><span class="line">            <span class="keyword">if</span> (!supp_gid.ok()) &#123;</span><br><span class="line">                <span class="keyword">return</span> Error() &lt;&lt; <span class="string">&quot;Unable to decode GID for &#x27;&quot;</span> &lt;&lt; args[<span class="number">4</span> + i]</span><br><span class="line">                               &lt;&lt; <span class="string">&quot;&#x27;: &quot;</span> &lt;&lt; supp_gid.error();</span><br><span class="line">            &#125;</span><br><span class="line">            supp_gids.push_back(*supp_gid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, flags, *uid, *gid, supp_gids, namespace_flags, seclabel,</span><br><span class="line">                                     nullptr, <span class="comment">/*filename=*/</span><span class="string">&quot;&quot;</span>, str_args);<span class="comment">//构建一个service对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;解析完成后，就是启动service,以启动Zygote为例</p>
<ul>
<li>system&#x2F;core&#x2F;init&#x2F;builtins.cpp<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static Result&lt;void&gt; do_class_start(const BuiltinArguments&amp; args) &#123;</span><br><span class="line">    // Do not start a class if it has a property persist.dont_start_class.CLASS set to 1.</span><br><span class="line">    if (android::base::GetBoolProperty(&quot;persist.init.dont_start_class.&quot; + args[1], false))</span><br><span class="line">        return &#123;&#125;;</span><br><span class="line">    // Starting a class does not start services which are explicitly disabled.</span><br><span class="line">    // They must  be started individually.</span><br><span class="line">    for (const auto&amp; service : ServiceList::GetInstance()) &#123;</span><br><span class="line">        if (service-&gt;classnames().count(args[1])) &#123;</span><br><span class="line">            if (auto result = service-&gt;StartIfNotDisabled(); !result.ok()) &#123;</span><br><span class="line">                LOG(ERROR) &lt;&lt; &quot;Could not start service &#x27;&quot; &lt;&lt; service-&gt;name()</span><br><span class="line">                           &lt;&lt; &quot;&#x27; as part of class &#x27;&quot; &lt;&lt; args[1] &lt;&lt; &quot;&#x27;: &quot; &lt;&lt; result.error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>system&#x2F;core&#x2F;init&#x2F;service.cpp<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">Result&lt;void&gt; Service::Start() &#123;</span><br><span class="line">    auto reboot_on_failure = make_scope_guard([this] &#123;</span><br><span class="line">        if (on_failure_reboot_target_) &#123;</span><br><span class="line">            trigger_shutdown(*on_failure_reboot_target_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    if (is_updatable() &amp;&amp; !ServiceList::GetInstance().IsServicesUpdated()) &#123;</span><br><span class="line">        ServiceList::GetInstance().DelayService(*this);</span><br><span class="line">        return Error() &lt;&lt; &quot;Cannot start an updatable service &#x27;&quot; &lt;&lt; name_</span><br><span class="line">                       &lt;&lt; &quot;&#x27; before configs from APEXes are all loaded. &quot;</span><br><span class="line">                       &lt;&lt; &quot;Queued for execution.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bool disabled = (flags_ &amp; (SVC_DISABLED | SVC_RESET));</span><br><span class="line">    ResetFlagsForStart();</span><br><span class="line"></span><br><span class="line">    // Running processes require no additional work --- if they&#x27;re in the</span><br><span class="line">    // process of exiting, we&#x27;ve ensured that they will immediately restart</span><br><span class="line">    // on exit, unless they are ONESHOT. For ONESHOT service, if it&#x27;s in</span><br><span class="line">    // stopping status, we just set SVC_RESTART flag so it will get restarted</span><br><span class="line">    // in Reap().</span><br><span class="line">    //如果service已经运行，则不启动</span><br><span class="line">    if (flags_ &amp; SVC_RUNNING) &#123;</span><br><span class="line">        if ((flags_ &amp; SVC_ONESHOT) &amp;&amp; disabled) &#123;</span><br><span class="line">            flags_ |= SVC_RESTART;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG(INFO) &lt;&lt; &quot;service &#x27;&quot; &lt;&lt; name_</span><br><span class="line">                  &lt;&lt; &quot;&#x27; requested start, but it is already running (flags: &quot; &lt;&lt; flags_ &lt;&lt; &quot;)&quot;;</span><br><span class="line"></span><br><span class="line">        // It is not an error to try to start a service that is already running.</span><br><span class="line">        reboot_on_failure.Disable();</span><br><span class="line">        return &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // cgroups_activated is used for communication from the parent to the child</span><br><span class="line">    // while setsid_finished is used for communication from the child process to</span><br><span class="line">    // the parent process. These two communication channels are separate because</span><br><span class="line">    // combining these into a single communication channel would introduce a</span><br><span class="line">    // race between the Write() calls by the parent and by the child.</span><br><span class="line">    InterprocessFifo cgroups_activated, setsid_finished;</span><br><span class="line">    OR_RETURN(cgroups_activated.Initialize());</span><br><span class="line">    OR_RETURN(setsid_finished.Initialize());</span><br><span class="line"></span><br><span class="line">    if (Result&lt;void&gt; result = CheckConsole(); !result.ok()) &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    //判断需要启动的service的对应执行文件是否存在，不存在就不启动service struct</span><br><span class="line">    struct stat sb;</span><br><span class="line">    if (stat(args_[0].c_str(), &amp;sb) == -1) &#123;</span><br><span class="line">        flags_ |= SVC_DISABLED;</span><br><span class="line">        return ErrnoError() &lt;&lt; &quot;Cannot find &#x27;&quot; &lt;&lt; args_[0] &lt;&lt; &quot;&#x27;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string scon;</span><br><span class="line">    if (!seclabel_.empty()) &#123;</span><br><span class="line">        scon = seclabel_;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        auto result = ComputeContextFromExecutable(args_[0]);</span><br><span class="line">        if (!result.ok()) &#123;</span><br><span class="line">            return result.error();</span><br><span class="line">        &#125;</span><br><span class="line">        scon = *result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!mount_namespace_.has_value()) &#123;</span><br><span class="line">        // remember from which mount namespace the service should start</span><br><span class="line">        SetMountNamespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    post_data_ = ServiceList::GetInstance().IsPostData();</span><br><span class="line"></span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;starting service &#x27;&quot; &lt;&lt; name_ &lt;&lt; &quot;&#x27;...&quot;;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;Descriptor&gt; descriptors;</span><br><span class="line">    for (const auto&amp; socket : sockets_) &#123;</span><br><span class="line">        if (auto result = socket.Create(scon); result.ok()) &#123;</span><br><span class="line">            descriptors.emplace_back(std::move(*result));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            LOG(INFO) &lt;&lt; &quot;Could not create socket &#x27;&quot; &lt;&lt; socket.name &lt;&lt; &quot;&#x27;: &quot; &lt;&lt; result.error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (const auto&amp; file : files_) &#123;</span><br><span class="line">        if (auto result = file.Create(); result.ok()) &#123;</span><br><span class="line">            descriptors.emplace_back(std::move(*result));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            LOG(INFO) &lt;&lt; &quot;Could not open file &#x27;&quot; &lt;&lt; file.name &lt;&lt; &quot;&#x27;: &quot; &lt;&lt; result.error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //如果子进程没有启动，则调用fork()函数创建子进程</span><br><span class="line">    pid_t pid = -1;</span><br><span class="line">    if (namespaces_.flags) &#123;</span><br><span class="line">        pid = clone(nullptr, nullptr, namespaces_.flags | SIGCHLD, nullptr);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pid == 0) &#123;//当前代码逻辑在子进程中运行</span><br><span class="line">        umask(077);</span><br><span class="line">        cgroups_activated.CloseWriteFd();</span><br><span class="line">        setsid_finished.CloseReadFd();</span><br><span class="line">        RunService(descriptors, std::move(cgroups_activated), std::move(setsid_finished));</span><br><span class="line">        _exit(127);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        cgroups_activated.CloseReadFd();</span><br><span class="line">        setsid_finished.CloseWriteFd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pid &lt; 0) &#123;</span><br><span class="line">        pid_ = 0;</span><br><span class="line">        return ErrnoError() &lt;&lt; &quot;Failed to fork&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    once_environment_vars_.clear();</span><br><span class="line"></span><br><span class="line">    if (oom_score_adjust_ != DEFAULT_OOM_SCORE_ADJUST) &#123;</span><br><span class="line">        std::string oom_str = std::to_string(oom_score_adjust_);</span><br><span class="line">        std::string oom_file = StringPrintf(&quot;/proc/%d/oom_score_adj&quot;, pid);</span><br><span class="line">        if (!WriteStringToFile(oom_str, oom_file)) &#123;</span><br><span class="line">            PLOG(ERROR) &lt;&lt; &quot;couldn&#x27;t write oom_score_adj&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    time_started_ = boot_clock::now();</span><br><span class="line">    pid_ = pid;</span><br><span class="line">    flags_ |= SVC_RUNNING;</span><br><span class="line">    start_order_ = next_start_order_++;</span><br><span class="line">    process_cgroup_empty_ = false;</span><br><span class="line"></span><br><span class="line">    if (CgroupsAvailable()) &#123;</span><br><span class="line">        bool use_memcg = swappiness_ != -1 || soft_limit_in_bytes_ != -1 || limit_in_bytes_ != -1 ||</span><br><span class="line">                         limit_percent_ != -1 || !limit_property_.empty();</span><br><span class="line">        errno = -createProcessGroup(proc_attr_.uid, pid_, use_memcg);</span><br><span class="line">        if (errno != 0) &#123;</span><br><span class="line">            Result&lt;void&gt; result = cgroups_activated.Write(kActivatingCgroupsFailed);</span><br><span class="line">            if (!result.ok()) &#123;</span><br><span class="line">                return Error() &lt;&lt; &quot;Sending notification failed: &quot; &lt;&lt; result.error();</span><br><span class="line">            &#125;</span><br><span class="line">            return Error() &lt;&lt; &quot;createProcessGroup(&quot; &lt;&lt; proc_attr_.uid &lt;&lt; &quot;, &quot; &lt;&lt; pid_ &lt;&lt; &quot;, &quot;</span><br><span class="line">                           &lt;&lt; use_memcg &lt;&lt; &quot;) failed for service &#x27;&quot; &lt;&lt; name_</span><br><span class="line">                           &lt;&lt; &quot;&#x27;: &quot; &lt;&lt; strerror(errno);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // When the blkio controller is mounted in the v1 hierarchy, NormalIoPriority is</span><br><span class="line">        // the default (/dev/blkio). When the blkio controller is mounted in the v2 hierarchy, the</span><br><span class="line">        // NormalIoPriority profile has to be applied explicitly.</span><br><span class="line">        SetProcessProfiles(proc_attr_.uid, pid_, &#123;&quot;NormalIoPriority&quot;&#125;);</span><br><span class="line"></span><br><span class="line">        if (use_memcg) &#123;</span><br><span class="line">            ConfigureMemcg();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (oom_score_adjust_ != DEFAULT_OOM_SCORE_ADJUST) &#123;</span><br><span class="line">        LmkdRegister(name_, proc_attr_.uid, pid_, oom_score_adjust_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (Result&lt;void&gt; result = cgroups_activated.Write(kCgroupsActivated); !result.ok()) &#123;</span><br><span class="line">        return Error() &lt;&lt; &quot;Sending cgroups activated notification failed: &quot; &lt;&lt; result.error();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cgroups_activated.Close();</span><br><span class="line"></span><br><span class="line">    // Call setpgid() from the parent process to make sure that this call has</span><br><span class="line">    // finished before the parent process calls kill(-pgid, ...).</span><br><span class="line">    if (!RequiresConsole(proc_attr_)) &#123;</span><br><span class="line">        if (setpgid(pid, pid) &lt; 0) &#123;</span><br><span class="line">            switch (errno) &#123;</span><br><span class="line">                case EACCES:  // Child has already performed setpgid() followed by execve().</span><br><span class="line">                case ESRCH:   // Child process no longer exists.</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    PLOG(ERROR) &lt;&lt; &quot;setpgid() from parent failed&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // The Read() call below will return an error if the child is killed.</span><br><span class="line">        if (Result&lt;uint8_t&gt; result = setsid_finished.Read();</span><br><span class="line">            !result.ok() || *result != kSetSidFinished) &#123;</span><br><span class="line">            if (!result.ok()) &#123;</span><br><span class="line">                return Error() &lt;&lt; &quot;Waiting for setsid() failed: &quot; &lt;&lt; result.error();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return Error() &lt;&lt; &quot;Waiting for setsid() failed: &quot; &lt;&lt; static_cast&lt;uint32_t&gt;(*result)</span><br><span class="line">                               &lt;&lt; &quot; &lt;&gt; &quot; &lt;&lt; static_cast&lt;uint32_t&gt;(kSetSidFinished);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid_finished.Close();</span><br><span class="line"></span><br><span class="line">    NotifyStateChange(&quot;running&quot;);</span><br><span class="line">    reboot_on_failure.Disable();</span><br><span class="line"></span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;... started service &#x27;&quot; &lt;&lt; name_ &lt;&lt; &quot;&#x27; has pid &quot; &lt;&lt; pid_;</span><br><span class="line"></span><br><span class="line">    return &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Zygote"><a href="#Zygote" class="headerlink" title="Zygote"></a>Zygote</h3><p>&emsp;&emsp;Zygote中文翻译是“受精卵“，正如其名，它主要用于孵化子进程。在Android系统中有两种程序:</p>
<ul>
<li>java应用程序，主要基于ART虚拟机，所有的应用程序apk都属于这类native程序，也就是利用C或C++语言开发的程序，如Bootanimation。所有的Java应用程序进程及系统服务SystemServer进程都由Zygote进程通过Linux的fork()函数孵化出来的，而native程序则由init程序创建启动。最初的名字是app_process。Zygote是Android中的第一个art虚拟机，通过socket的方式与其他进程进行通信。Zygote是一个C&#x2F;S模型，Zygote进程作为服务端，它主要负责创建Java虚拟机，加载系统资源，启动SystemServer进程，以及在后续运行过程中启动普通的应用程序，其他进程作为客户端向它发出“孵化”请求，而Zygote接收到这个请求后就“孵化”出一个新的进程。比如，当点击Launcher里的应用图标去启动一个新的应用程序时，这个请求会到达框架层的核心服务ActivityMangerService中，当AMS受到这个请求后，它通过调用Process类发出一个“孵化”子进程的Socket请求，而Zygote监听到这个请求后就立刻fork一个新的进程出来。</li>
</ul>
<h4 id="Zygote触发过程"><a href="#Zygote触发过程" class="headerlink" title="Zygote触发过程"></a>Zygote触发过程</h4><ol>
<li>init.zygoteXX.rc</li>
</ol>
<blockquote>
<p>import &#x2F;init.${ro.zygote}.rc</p>
</blockquote>
<p>&emsp;&emsp;${ro.zygote}会被替换成ro.zygote的属性值，这个是由不同的硬件厂商自己定制，有4个值</p>
<ul>
<li>zygote32：zygote进程对应的执行程序是app_process(纯32bit模式)</li>
<li>zygote64：zygote进程对应的执行程序是app_process64(纯64bit模式)</li>
<li>zygote32_64：启动两个zygote进程(名为zygote和zygote_secondary)，对应的执行程序，对应的执行程序app_process32(主模式)</li>
<li>zygote64_32：启动两个zygote进程(名为zygote和zygote_secondary)，对应的执行程序分别是app_process64(主模式)、app_process32</li>
</ul>
<ol start="2">
<li>start zygote</li>
</ol>
<ul>
<li>system&#x2F;core&#x2F;rootdir&#x2F;init.rc</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># Line 1070</span><br><span class="line"># It is recommended to put unnecessary data/ initialization from post-fs-data</span><br><span class="line"># to start-zygote in device&#x27;s init.rc to unblock zygote start.</span><br><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted</span><br><span class="line">    wait_for_prop odsign.verification.done 1</span><br><span class="line">    # A/B update verifier that marks a successful boot.</span><br><span class="line">    exec_start update_verifier_nonencrypted</span><br><span class="line">    start statsd</span><br><span class="line">    start netd</span><br><span class="line">    start zygote</span><br><span class="line">    start zygote_secondary</span><br><span class="line"></span><br><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=unsupported</span><br><span class="line">    wait_for_prop odsign.verification.done 1</span><br><span class="line">    # A/B update verifier that marks a successful boot.</span><br><span class="line">    exec_start update_verifier_nonencrypted</span><br><span class="line">    start statsd</span><br><span class="line">    start netd</span><br><span class="line">    start zygote</span><br><span class="line">    start zygote_secondary</span><br><span class="line"></span><br><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=encrypted &amp;&amp; property:ro.crypto.type=file</span><br><span class="line">    wait_for_prop odsign.verification.done 1</span><br><span class="line">    # A/B update verifier that marks a successful boot.</span><br><span class="line">    exec_start update_verifier_nonencrypted</span><br><span class="line">    start statsd</span><br><span class="line">    start netd</span><br><span class="line">    start zygote</span><br><span class="line">    start zygote_secondary</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;zygote-start是在on late-init触发的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">## line 532</span><br><span class="line"></span><br><span class="line">on late-init</span><br><span class="line">    trigger early-fs</span><br><span class="line"></span><br><span class="line">    # Mount fstab in init.&#123;$device&#125;.rc by mount_all command. Optional parameter</span><br><span class="line">    # &#x27;--early&#x27; can be specified to skip entries with &#x27;latemount&#x27;.</span><br><span class="line">    # /system and /vendor must be mounted by the end of the fs stage,</span><br><span class="line">    # while /data is optional.</span><br><span class="line">    trigger fs</span><br><span class="line">    trigger post-fs</span><br><span class="line"></span><br><span class="line">    # Mount fstab in init.&#123;$device&#125;.rc by mount_all with &#x27;--late&#x27; parameter</span><br><span class="line">    # to only mount entries with &#x27;latemount&#x27;. This is needed if &#x27;--early&#x27; is</span><br><span class="line">    # specified in the previous mount_all command on the fs stage.</span><br><span class="line">    # With /system mounted and properties form /system + /factory available,</span><br><span class="line">    # some services can be started.</span><br><span class="line">    trigger late-fs</span><br><span class="line"></span><br><span class="line">    # Now we can mount /data. File encryption requires keymaster to decrypt</span><br><span class="line">    # /data, which in turn can only be loaded when system properties are present.</span><br><span class="line">    trigger post-fs-data</span><br><span class="line"></span><br><span class="line">    # Should be before netd, but after apex, properties and logging is available.</span><br><span class="line">    trigger load_bpf_programs</span><br><span class="line"></span><br><span class="line">    # Now we can start zygote for devices with file based encryption</span><br><span class="line">    trigger zygote-start</span><br><span class="line"></span><br><span class="line">    # Remove a file to wake up anything waiting for firmware.</span><br><span class="line">    trigger firmware_mounts_complete</span><br><span class="line"></span><br><span class="line">    trigger early-boot</span><br><span class="line">    trigger boot</span><br><span class="line"></span><br><span class="line"># Line 1346</span><br><span class="line">on userspace-reboot-resume</span><br><span class="line">  trigger userspace-reboot-fs-remount</span><br><span class="line">  trigger post-fs-data</span><br><span class="line">  trigger zygote-start</span><br><span class="line">  trigger early-boot</span><br><span class="line">  trigger boot</span><br></pre></td></tr></table></figure>

<h4 id="Zygote启动过程"><a href="#Zygote启动过程" class="headerlink" title="Zygote启动过程"></a>Zygote启动过程</h4><ul>
<li>frameworks&#x2F;base&#x2F;cmds&#x2F;app_process&#x2F;app_main.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...Line 264</span></span><br><span class="line"> <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--nice-name=&quot;</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--&quot;</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">//这些Java的应用都是通过AppRuntime.start(className)开始的</span></span><br><span class="line">        <span class="comment">//其实AppRuntime是AndroidRuntime的子类，它主要实现了几个回调函数，而start()方法是实现在AndroidRutime这个方法类里</span></span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        runtime.start(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在app_main.cpp的main函数中，主要做的事情就是参数解析，这个函数有两种启动模式:</p>
<ol>
<li>一种zygote模式，也就是初始化zygote进程，传递的参数有–start-system-server –socket- name&#x3D;zygote，前者表示启动SystemServer，后者指定socket的名称</li>
<li>一种是application模式，也就是启动普通应用程序，传递的参数有class名字以及class带的参数两者最终都是调用AppRuntime对象的start函数，加载ZygoteInit或RuntimeInit两个Java类，并将之前整理的参数传入进去。</li>
</ol>
<p>&emsp;&emsp;app_process里面定义了三种应用程序类型:</p>
<ul>
<li>Zygote：com.android.internal.os.ZygoteInit</li>
<li>System Server，不单独启动，而是由Zygote启动</li>
<li>其他指定类名的Java程序</li>
</ul>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
    graph TB
    main[App_main.main] --&gt; androidRuntime[AndroidRuntime.start]
    androidRuntime --&gt; startVm[startVm]
    startVm --&gt; startReg[startReg]  
    startReg --&gt; zygoteinit_main[ZygoteInit.main]  
    zygoteinit_main --&gt; registerZygoteSocket[registerZygoteSocket]
    registerZygoteSocket --&gt; preload[preload]
    preload --&gt; startSystemServer[startSystemServer]
    startSystemServer --&gt; runSelectLoop[runSelectLoop] 

  </pre></div>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">class AppRuntime : public AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    AppRuntime(char* argBlockStart, const size_t argBlockLength)</span><br><span class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</span><br><span class="line">        , mClass(NULL)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void setClassNameAndArgs(const String8&amp; className, int argc, char * const *argv) &#123;</span><br><span class="line">        mClassName = className;</span><br><span class="line">        for (int i = 0; i &lt; argc; ++i) &#123;</span><br><span class="line">             mArgs.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void onVmCreated(JNIEnv* env)</span><br><span class="line">    &#123;</span><br><span class="line">        if (mClassName.isEmpty()) &#123;</span><br><span class="line">            return; // Zygote. Nothing to do here.</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * This is a little awkward because the JNI FindClass call uses the</span><br><span class="line">         * class loader associated with the native method we&#x27;re executing in.</span><br><span class="line">         * If called in onStarted (from RuntimeInit.finishInit because we&#x27;re</span><br><span class="line">         * launching &quot;am&quot;, for example), FindClass would see that we&#x27;re calling</span><br><span class="line">         * from a boot class&#x27; native method, and so wouldn&#x27;t look for the class</span><br><span class="line">         * we&#x27;re trying to look up in CLASSPATH. Unfortunately it needs to,</span><br><span class="line">         * because the &quot;am&quot; classes are not boot classes.</span><br><span class="line">         *</span><br><span class="line">         * The easiest fix is to call FindClass here, early on before we start</span><br><span class="line">         * executing boot class Java code and thereby deny ourselves access to</span><br><span class="line">         * non-boot classes.</span><br><span class="line">         */</span><br><span class="line">        char* slashClassName = toSlashClassName(mClassName.string());</span><br><span class="line">        mClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">        if (mClass == NULL) &#123;</span><br><span class="line">            ALOGE(&quot;ERROR: could not find class &#x27;%s&#x27;\n&quot;, mClassName.string());</span><br><span class="line">        &#125;</span><br><span class="line">        free(slashClassName);</span><br><span class="line"></span><br><span class="line">        mClass = reinterpret_cast&lt;jclass&gt;(env-&gt;NewGlobalRef(mClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void onStarted()</span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(&quot;App process: starting thread pool.\n&quot;);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">        ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void onZygoteInit()</span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(&quot;App process: starting thread pool.\n&quot;);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual void onExit(int code)</span><br><span class="line">    &#123;</span><br><span class="line">        if (mClassName.isEmpty()) &#123;</span><br><span class="line">            // if zygote</span><br><span class="line">            IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">            hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AndroidRuntime::onExit(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String8 mClassName;</span><br><span class="line">    Vector&lt;String8&gt; mArgs;</span><br><span class="line">    jclass mClass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>什么是Runtime?</p>
<ul>
<li>Runtime是支撑程序运行的基础库，它与语言绑定在一起。</li>
<li>C Runtime:就是C standard lib也就是常说的libc(有趣的是Wiki自动将“C runtime”重定向到”C Standard Library)</li>
<li>Java Runtime: 同样，Wiki将其重定向到“Java Virtual Machine”，这里当然包括Java的支撑类库</li>
<li>AndroidRuntime:显而易见，就是为Android应用运行所需的运行时环境。这个环境包括一下东西。<ul>
<li>Dalvik VM:Android 的Java VM,解释运行Dex格式Java程序。每个进程运行一个虚拟机(什么叫运行虚拟机？就是一些C代码，不停的去解释Dex格式的二进制码(Bytecode)，把他们转换称机器码Machine code,现在大多数java虚拟机都支持JIT，bytecode可能在运行前就已经被转换成机器码，从而大大提高了性能。在某些情况下，Java甚至可以比C&#x2F;C++跑得更快，同时又兼具平台无关的特性)。</li>
<li>Android的Java类库，大部分来自于Apache Hamony,开源的Java API实现，如java.lang,java.util,java.net,但去除了AWT,Swing等部件</li>
<li>JNI: C和Java互调的接口</li>
<li>Libc: Android也有很多C代码，自然少不了libc,注意的是，Android的libc叫bionic C.</li>
</ul>
</li>
</ul>
</li>
<li><p>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;AndroidRuntime.cpp</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Line 1175</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine</span></span><br><span class="line"><span class="comment"> * and calling the &quot;static void main(String[] args)&quot; method in the class</span></span><br><span class="line"><span class="comment"> * named by &quot;className&quot;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Passes the main function two arguments, the class name and the specified</span></span><br><span class="line"><span class="comment"> * options string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">AndroidRuntime::start</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* className, <span class="type">const</span> Vector&lt;String8&gt;&amp; options, <span class="type">bool</span> zygote)</span></span><br><span class="line">&#123;</span><br><span class="line">    ALOGD(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n&quot;</span>,</span><br><span class="line">            className != <span class="literal">NULL</span> ? className : <span class="string">&quot;(unknown)&quot;</span>, getuid());</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> String8 <span class="title function_">startSystemServer</span><span class="params">(<span class="string">&quot;start-system-server&quot;</span>)</span>;</span><br><span class="line">    <span class="comment">// Whether this is the primary zygote, meaning the zygote which will fork system server.</span></span><br><span class="line">    <span class="type">bool</span> primary_zygote = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * &#x27;startSystemServer == true&#x27; means runtime is obsolete and not run from</span></span><br><span class="line"><span class="comment">     * init.rc anymore, so we print out the boot start event here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">            primary_zygote = <span class="literal">true</span>;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="type">const</span> <span class="type">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* rootDir = getenv(<span class="string">&quot;ANDROID_ROOT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">&quot;/system&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">&quot;/system&quot;</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">&quot;No root directory specified, and /system does not exist.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">&quot;ANDROID_ROOT&quot;</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* artRootDir = getenv(<span class="string">&quot;ANDROID_ART_ROOT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (artRootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">&quot;No ART directory specified with ANDROID_ART_ROOT environment variable.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* i18nRootDir = getenv(<span class="string">&quot;ANDROID_I18N_ROOT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (i18nRootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">&quot;No runtime directory specified with ANDROID_I18N_ROOT environment variable.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* tzdataRootDir = getenv(<span class="string">&quot;ANDROID_TZDATA_ROOT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (tzdataRootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        LOG_FATAL(<span class="string">&quot;No tz data directory specified with ANDROID_TZDATA_ROOT environment variable.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const char* kernelHack = getenv(&quot;LD_ASSUME_KERNEL&quot;);</span></span><br><span class="line">    <span class="comment">//ALOGD(&quot;Found LD_ASSUME_KERNEL=&#x27;%s&#x27;\n&quot;, kernelHack);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Register android functions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Unable to register all android natives\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment">     * Create an array to hold them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">&quot;Shutting down VM\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">&quot;Warning: unable to detach main thread\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">&quot;Warning: VM did not shut down cleanly\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Java虚拟机的启动大致做了如下事情</li>
</ul>
<ol>
<li><p>从property读取一系列启动参数</p>
</li>
<li><p>创建和初始化结构体全局对象(每个进程)gDVM,及对应与JavaVM和JNIEnv的内部结构体JavaVMExt,JNIEnvExt</p>
</li>
<li><p>初始化java虚拟机，并创建虚拟机线程</p>
</li>
<li><p>注册系统的JNI,Java程序通过这些JNI接口来访问底层的资源。</p>
<ul>
<li>loadJniLibrary(“javacode”); loadJniLibrary(“nativehelper”);</li>
</ul>
</li>
<li><p>为Zygote的启动做最后的准备，包括设置SID&#x2F;UID,以及mount 文件系统</p>
</li>
<li><p>返回JavaVM给Native代码，这样它就可以向上访问Java的接口</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 634</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">AndroidRuntime::startVm</span><span class="params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="type">bool</span> zygote, <span class="type">bool</span> primary_zygote)</span></span><br><span class="line">&#123;</span><br><span class="line">    JavaVMInitArgs initArgs;</span><br><span class="line">    <span class="type">char</span> propBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="type">char</span> jniOptsBuf[<span class="keyword">sizeof</span>(<span class="string">&quot;-Xjniopts:&quot;</span>)<span class="number">-1</span> + PROPERTY_VALUE_MAX];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//more....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Initialize the VM.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.</span></span><br><span class="line"><span class="comment">     * If this call succeeds, the VM is ready, and we can start issuing</span></span><br><span class="line"><span class="comment">     * JNI calls.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">//startVM的前半部分是在处理虚拟机的启动参数，处理完配置参数后，会调用libart.so提供的一个接口JNI_CreateJavaVM函数</span></span><br><span class="line">    <span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>art&#x2F;runtime&#x2F;jni&#x2F;java_vm_ext.cc</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> jint <span class="title function_">JNI_CreateJavaVM</span><span class="params">(JavaVM** p_vm, JNIEnv** p_env, <span class="type">void</span>* vm_args)</span> &#123;</span><br><span class="line">  ScopedTrace <span class="title function_">trace</span><span class="params">(__FUNCTION__)</span>;</span><br><span class="line">  <span class="type">const</span> JavaVMInitArgs* args = static_cast&lt;JavaVMInitArgs*&gt;(vm_args);</span><br><span class="line">  <span class="keyword">if</span> (JavaVMExt::IsBadJniVersion(args-&gt;version)) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">&quot;Bad JNI version passed to CreateJavaVM: &quot;</span> &lt;&lt; args-&gt;version;</span><br><span class="line">    <span class="keyword">return</span> JNI_EVERSION;</span><br><span class="line">  &#125;</span><br><span class="line">  RuntimeOptions options;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; args-&gt;nOptions; ++i) &#123;</span><br><span class="line">    JavaVMOption* option = &amp;args-&gt;options[i];</span><br><span class="line">    options.push_back(<span class="built_in">std</span>::<span class="built_in">make_pair</span>(<span class="built_in">std</span>::<span class="built_in">string</span>(option-&gt;optionString), option-&gt;extraInfo));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">bool</span> ignore_unrecognized = args-&gt;ignoreUnrecognized;</span><br><span class="line">  <span class="comment">//通过Runtime的create方法创建单例的Runtime对象</span></span><br><span class="line">  <span class="keyword">if</span> (!Runtime::Create(options, ignore_unrecognized)) &#123;</span><br><span class="line">    <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When `ART_CRASH_RUNTIME_DELIBERATELY` is defined (which happens only in the</span></span><br><span class="line">  <span class="comment">// case of a test APEX), we crash the runtime here on purpose, to test the</span></span><br><span class="line">  <span class="comment">// behavior of rollbacks following a failed ART Mainline Module update.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ART_CRASH_RUNTIME_DELIBERATELY</span></span><br><span class="line">  LOG(FATAL) &lt;&lt; <span class="string">&quot;Runtime crashing deliberately for testing purposes.&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize native loader. This step makes sure we have</span></span><br><span class="line">  <span class="comment">// everything set up before we start using JNI.</span></span><br><span class="line">  android::InitializeNativeLoader();</span><br><span class="line"></span><br><span class="line">  Runtime* runtime = Runtime::Current();</span><br><span class="line">  <span class="type">bool</span> started = runtime-&gt;Start();</span><br><span class="line">  <span class="keyword">if</span> (!started) &#123;</span><br><span class="line">    delete <span class="title function_">Thread::Current</span><span class="params">()</span>-&gt;<span class="title function_">GetJniEnv</span><span class="params">()</span>;</span><br><span class="line">    delete runtime-&gt;GetJavaVM();</span><br><span class="line">    LOG(WARNING) &lt;&lt; <span class="string">&quot;CreateJavaVM failed&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *p_env = Thread::Current()-&gt;GetJniEnv();</span><br><span class="line">  *p_vm = runtime-&gt;GetJavaVM();</span><br><span class="line">  <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;首先通过Runtime的create方法创建单例的Runtime对象，runtime负责提供art虚拟机的运行时环境，然后调用其init方法来初始化虚拟机</p>
<ul>
<li>art&#x2F;runtime&#x2F;runtime.cc</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">Runtime::Init</span><span class="params">(RuntimeArgumentMap&amp;&amp; runtime_options_in)</span> &#123;</span><br><span class="line">  <span class="comment">//more ....</span></span><br><span class="line">  <span class="comment">//创建堆管理对象</span></span><br><span class="line">  heap_ = new gc::Heap(runtime_options.GetOrDefault(Opt::MemoryInitialSize),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapGrowthLimit),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapMinFree),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapMaxFree),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HeapTargetUtilization),</span><br><span class="line">                       foreground_heap_growth_multiplier,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::StopForNativeAllocs),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::MemoryMaximumSize),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::NonMovingSpaceCapacity),</span><br><span class="line">                       GetBootClassPath(),</span><br><span class="line">                       GetBootClassPathLocations(),</span><br><span class="line">                       GetBootClassPathFds(),</span><br><span class="line">                       GetBootClassPathImageFds(),</span><br><span class="line">                       GetBootClassPathVdexFds(),</span><br><span class="line">                       GetBootClassPathOatFds(),</span><br><span class="line">                       image_locations_,</span><br><span class="line">                       instruction_set_,</span><br><span class="line">                       <span class="comment">// Override the collector type to CC if the read barrier config.</span></span><br><span class="line">                       gUseReadBarrier ? gc::kCollectorTypeCC : xgc_option.collector_type_,</span><br><span class="line">                       background_gc,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectSpace),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectThreshold),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::ParallelGCThreads),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::ConcGCThreads),</span><br><span class="line">                       runtime_options.Exists(Opt::LowMemoryMode),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LongPauseLogThreshold),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::LongGCLogThreshold),</span><br><span class="line">                       runtime_options.Exists(Opt::IgnoreMaxFootprint),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::AlwaysLogExplicitGcs),</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::UseTLAB),</span><br><span class="line">                       xgc_option.verify_pre_gc_heap_,</span><br><span class="line">                       xgc_option.verify_pre_sweeping_heap_,</span><br><span class="line">                       xgc_option.verify_post_gc_heap_,</span><br><span class="line">                       xgc_option.verify_pre_gc_rosalloc_,</span><br><span class="line">                       xgc_option.verify_pre_sweeping_rosalloc_,</span><br><span class="line">                       xgc_option.verify_post_gc_rosalloc_,</span><br><span class="line">                       xgc_option.gcstress_,</span><br><span class="line">                       xgc_option.measure_,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::EnableHSpaceCompactForOOM),</span><br><span class="line">                       use_generational_cc,</span><br><span class="line">                       runtime_options.GetOrDefault(Opt::HSpaceCompactForOOMMinIntervalsMs),</span><br><span class="line">                       runtime_options.Exists(Opt::DumpRegionInfoBeforeGC),</span><br><span class="line">                       runtime_options.Exists(Opt::DumpRegionInfoAfterGC));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//more ....</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建java虚拟机对象</span></span><br><span class="line">  java_vm_ = JavaVMExt::Create(this, runtime_options, &amp;error_msg);</span><br><span class="line">  <span class="keyword">if</span> (java_vm_.get() == nullptr) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not initialize JavaVMExt: &quot;</span> &lt;&lt; error_msg;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the JniEnv handler.</span></span><br><span class="line">  <span class="comment">// TODO Refactor this stuff.</span></span><br><span class="line">  java_vm_-&gt;AddEnvironmentHook(JNIEnvExt::GetEnvHandler);</span><br><span class="line"></span><br><span class="line">  Thread::Startup();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ClassLinker needs an attached thread, but we can&#x27;t fully attach a thread without creating</span></span><br><span class="line">  <span class="comment">// objects. We can&#x27;t supply a thread group yet; it will be fixed later. Since we are the main</span></span><br><span class="line">  <span class="comment">// thread, we do not get a java peer.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//连接主线程</span></span><br><span class="line">  Thread* self = Thread::Attach(<span class="string">&quot;main&quot;</span>, <span class="literal">false</span>, nullptr, <span class="literal">false</span>, <span class="comment">/* should_run_callbacks= */</span> <span class="literal">true</span>);</span><br><span class="line">  CHECK_EQ(self-&gt;GetThreadId(), ThreadList::kMainThreadId);</span><br><span class="line">  CHECK(self != nullptr);</span><br><span class="line"></span><br><span class="line">  self-&gt;SetIsRuntimeThread(IsAotCompiler());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set us to runnable so tools using a runtime can allocate and GC by default</span></span><br><span class="line">  self-&gt;TransitionFromSuspendedToRunnable();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we&#x27;re attached, we can take the heap locks and validate the heap.</span></span><br><span class="line">  GetHeap()-&gt;EnableObjectValidation();</span><br><span class="line"></span><br><span class="line">  CHECK_GE(GetHeap()-&gt;GetContinuousSpaces().size(), <span class="number">1U</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建类连接器</span></span><br><span class="line">  <span class="keyword">if</span> (UNLIKELY(IsAotCompiler())) &#123;</span><br><span class="line">    class_linker_ = new AotClassLinker(intern_table_);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    class_linker_ = new ClassLinker(</span><br><span class="line">        intern_table_,</span><br><span class="line">        runtime_options.GetOrDefault(Opt::FastClassNotFoundException));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (GetHeap()-&gt;HasBootImageSpace()) &#123;</span><br><span class="line">    <span class="comment">//初始化类连接器</span></span><br><span class="line">    <span class="type">bool</span> result = class_linker_-&gt;InitFromBootImage(&amp;error_msg);</span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not initialize from image: &quot;</span> &lt;&lt; error_msg;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (kIsDebugBuild) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> image_space : GetHeap()-&gt;GetBootImageSpaces()) &#123;</span><br><span class="line">        image_space-&gt;VerifyImageAllocations();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      ScopedTrace <span class="title function_">trace2</span><span class="params">(<span class="string">&quot;AddImageStringsToTable&quot;</span>)</span>;</span><br><span class="line">      <span class="keyword">for</span> (gc::space::ImageSpace* image_space : heap_-&gt;GetBootImageSpaces()) &#123;</span><br><span class="line">        GetInternTable()-&gt;AddImageStringsToTable(image_space, VoidFunctor());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> total_components = gc::space::ImageSpace::GetNumberOfComponents(</span><br><span class="line">        ArrayRef&lt;gc::space::ImageSpace* <span class="type">const</span>&gt;(heap_-&gt;GetBootImageSpaces()));</span><br><span class="line">    <span class="keyword">if</span> (total_components != GetBootClassPath().size()) &#123;</span><br><span class="line">      <span class="comment">// The boot image did not contain all boot class path components. Load the rest.</span></span><br><span class="line">      CHECK_LT(total_components, GetBootClassPath().size());</span><br><span class="line">      <span class="type">size_t</span> start = total_components;</span><br><span class="line">      DCHECK_LT(start, GetBootClassPath().size());</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="type">const</span> DexFile&gt;&gt; extra_boot_class_path;</span><br><span class="line">      <span class="keyword">if</span> (runtime_options.Exists(Opt::BootClassPathDexList)) &#123;</span><br><span class="line">        extra_boot_class_path.swap(*runtime_options.GetOrDefault(Opt::BootClassPathDexList));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ArrayRef&lt;<span class="type">const</span> <span class="type">int</span>&gt; bcp_fds = start &lt; GetBootClassPathFds().size()</span><br><span class="line">            ? ArrayRef&lt;<span class="type">const</span> <span class="type">int</span>&gt;(GetBootClassPathFds()).SubArray(start)</span><br><span class="line">            : ArrayRef&lt;<span class="type">const</span> <span class="type">int</span>&gt;();</span><br><span class="line">        OpenBootDexFiles(ArrayRef&lt;<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(GetBootClassPath()).SubArray(start),</span><br><span class="line">                         ArrayRef&lt;<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(GetBootClassPathLocations()).SubArray(start),</span><br><span class="line">                         bcp_fds,</span><br><span class="line">                         &amp;extra_boot_class_path);</span><br><span class="line">      &#125;</span><br><span class="line">      class_linker_-&gt;AddExtraBootDexFiles(self, <span class="built_in">std</span>::move(extra_boot_class_path));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IsJavaDebuggable() || jit_options_-&gt;GetProfileSaverOptions().GetProfileBootClassPath()) &#123;</span><br><span class="line">      <span class="comment">// Deoptimize the boot image if debuggable  as the code may have been compiled non-debuggable.</span></span><br><span class="line">      <span class="comment">// Also deoptimize if we are profiling the boot class path.</span></span><br><span class="line">      ScopedThreadSuspension <span class="title function_">sts</span><span class="params">(self, ThreadState::kNative)</span>;</span><br><span class="line">      ScopedSuspendAll <span class="title function_">ssa</span><span class="params">(__FUNCTION__)</span>;</span><br><span class="line">      DeoptimizeBootImage();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="type">const</span> DexFile&gt;&gt; boot_class_path;</span><br><span class="line">    <span class="keyword">if</span> (runtime_options.Exists(Opt::BootClassPathDexList)) &#123;</span><br><span class="line">      boot_class_path.swap(*runtime_options.GetOrDefault(Opt::BootClassPathDexList));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      OpenBootDexFiles(ArrayRef&lt;<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(GetBootClassPath()),</span><br><span class="line">                       ArrayRef&lt;<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(GetBootClassPathLocations()),</span><br><span class="line">                       ArrayRef&lt;<span class="type">const</span> <span class="type">int</span>&gt;(GetBootClassPathFds()),</span><br><span class="line">                       &amp;boot_class_path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!class_linker_-&gt;InitWithoutImage(<span class="built_in">std</span>::move(boot_class_path), &amp;error_msg)) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not initialize without image: &quot;</span> &lt;&lt; error_msg;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should we move the following to InitWithoutImage?</span></span><br><span class="line">    SetInstructionSet(instruction_set_);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; kCalleeSaveSize; i++) &#123;</span><br><span class="line">      CalleeSaveType type = CalleeSaveType(i);</span><br><span class="line">      <span class="keyword">if</span> (!HasCalleeSaveMethod(type)) &#123;</span><br><span class="line">        SetCalleeSaveMethod(CreateCalleeSaveMethod(), type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now that the boot image space is set, cache the boot classpath checksums,</span></span><br><span class="line">  <span class="comment">// to be used when validating oat files.</span></span><br><span class="line">  ArrayRef&lt;gc::space::ImageSpace* <span class="type">const</span>&gt; <span class="title function_">image_spaces</span><span class="params">(GetHeap()-&gt;GetBootImageSpaces())</span>;</span><br><span class="line">  ArrayRef&lt;<span class="type">const</span> DexFile* <span class="type">const</span>&gt; <span class="title function_">bcp_dex_files</span><span class="params">(GetClassLinker()-&gt;GetBootClassPath())</span>;</span><br><span class="line">  boot_class_path_checksums_ = gc::space::ImageSpace::GetBootClassPathChecksums(image_spaces,</span><br><span class="line">                                                                                bcp_dex_files);</span><br><span class="line"></span><br><span class="line">  CHECK(class_linker_ != nullptr);</span><br><span class="line"></span><br><span class="line">  verifier::ClassVerifier::Init(class_linker_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (runtime_options.Exists(Opt::MethodTrace)) &#123;</span><br><span class="line">    trace_config_.reset(new TraceConfig());</span><br><span class="line">    trace_config_-&gt;trace_file = runtime_options.ReleaseOrDefault(Opt::MethodTraceFile);</span><br><span class="line">    trace_config_-&gt;trace_file_size = runtime_options.ReleaseOrDefault(Opt::MethodTraceFileSize);</span><br><span class="line">    trace_config_-&gt;trace_mode = Trace::TraceMode::kMethodTracing;</span><br><span class="line">    trace_config_-&gt;trace_output_mode = runtime_options.Exists(Opt::MethodTraceStreaming) ?</span><br><span class="line">        Trace::TraceOutputMode::kStreaming :</span><br><span class="line">        Trace::TraceOutputMode::kFile;</span><br><span class="line">    trace_config_-&gt;clock_source = runtime_options.GetOrDefault(Opt::MethodTraceClock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Remove this in a follow up CL. This isn&#x27;t used anywhere.</span></span><br><span class="line">  Trace::SetDefaultClockSource(runtime_options.GetOrDefault(Opt::ProfileClock));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (GetHeap()-&gt;HasBootImageSpace()) &#123;</span><br><span class="line">    <span class="type">const</span> ImageHeader&amp; image_header = GetHeap()-&gt;GetBootImageSpaces()[<span class="number">0</span>]-&gt;GetImageHeader();</span><br><span class="line">    ObjPtr&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt; boot_image_live_objects =</span><br><span class="line">        ObjPtr&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt;::DownCast(</span><br><span class="line">            image_header.GetImageRoot(ImageHeader::kBootImageLiveObjects));</span><br><span class="line">    pre_allocated_OutOfMemoryError_when_throwing_exception_ = GcRoot&lt;mirror::Throwable&gt;(</span><br><span class="line">        boot_image_live_objects-&gt;Get(ImageHeader::kOomeWhenThrowingException)-&gt;AsThrowable());</span><br><span class="line">    DCHECK(pre_allocated_OutOfMemoryError_when_throwing_exception_.Read()-&gt;GetClass()</span><br><span class="line">               -&gt;DescriptorEquals(<span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>));</span><br><span class="line">    pre_allocated_OutOfMemoryError_when_throwing_oome_ = GcRoot&lt;mirror::Throwable&gt;(</span><br><span class="line">        boot_image_live_objects-&gt;Get(ImageHeader::kOomeWhenThrowingOome)-&gt;AsThrowable());</span><br><span class="line">    DCHECK(pre_allocated_OutOfMemoryError_when_throwing_oome_.Read()-&gt;GetClass()</span><br><span class="line">               -&gt;DescriptorEquals(<span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>));</span><br><span class="line">    pre_allocated_OutOfMemoryError_when_handling_stack_overflow_ = GcRoot&lt;mirror::Throwable&gt;(</span><br><span class="line">        boot_image_live_objects-&gt;Get(ImageHeader::kOomeWhenHandlingStackOverflow)-&gt;AsThrowable());</span><br><span class="line">    DCHECK(pre_allocated_OutOfMemoryError_when_handling_stack_overflow_.Read()-&gt;GetClass()</span><br><span class="line">               -&gt;DescriptorEquals(<span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>));</span><br><span class="line">    pre_allocated_NoClassDefFoundError_ = GcRoot&lt;mirror::Throwable&gt;(</span><br><span class="line">        boot_image_live_objects-&gt;Get(ImageHeader::kNoClassDefFoundError)-&gt;AsThrowable());</span><br><span class="line">    DCHECK(pre_allocated_NoClassDefFoundError_.Read()-&gt;GetClass()</span><br><span class="line">               -&gt;DescriptorEquals(<span class="string">&quot;Ljava/lang/NoClassDefFoundError;&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Pre-allocate an OutOfMemoryError for the case when we fail to</span></span><br><span class="line">    <span class="comment">// allocate the exception to be thrown.</span></span><br><span class="line">    CreatePreAllocatedException(self,</span><br><span class="line">                                this,</span><br><span class="line">                                &amp;pre_allocated_OutOfMemoryError_when_throwing_exception_,</span><br><span class="line">                                <span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;OutOfMemoryError thrown while trying to throw an exception; &quot;</span></span><br><span class="line">                                    <span class="string">&quot;no stack trace available&quot;</span>);</span><br><span class="line">    <span class="comment">// Pre-allocate an OutOfMemoryError for the double-OOME case.</span></span><br><span class="line">    CreatePreAllocatedException(self,</span><br><span class="line">                                this,</span><br><span class="line">                                &amp;pre_allocated_OutOfMemoryError_when_throwing_oome_,</span><br><span class="line">                                <span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;OutOfMemoryError thrown while trying to throw OutOfMemoryError; &quot;</span></span><br><span class="line">                                    <span class="string">&quot;no stack trace available&quot;</span>);</span><br><span class="line">    <span class="comment">// Pre-allocate an OutOfMemoryError for the case when we fail to</span></span><br><span class="line">    <span class="comment">// allocate while handling a stack overflow.</span></span><br><span class="line">    CreatePreAllocatedException(self,</span><br><span class="line">                                this,</span><br><span class="line">                                &amp;pre_allocated_OutOfMemoryError_when_handling_stack_overflow_,</span><br><span class="line">                                <span class="string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;OutOfMemoryError thrown while trying to handle a stack overflow; &quot;</span></span><br><span class="line">                                    <span class="string">&quot;no stack trace available&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pre-allocate a NoClassDefFoundError for the common case of failing to find a system class</span></span><br><span class="line">    <span class="comment">// ahead of checking the application&#x27;s class loader.</span></span><br><span class="line">    CreatePreAllocatedException(self,</span><br><span class="line">                                this,</span><br><span class="line">                                &amp;pre_allocated_NoClassDefFoundError_,</span><br><span class="line">                                <span class="string">&quot;Ljava/lang/NoClassDefFoundError;&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;Class not found using the boot class loader; &quot;</span></span><br><span class="line">                                    <span class="string">&quot;no stack trace available&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Class-roots are setup, we can now finish initializing the JniIdManager.</span></span><br><span class="line">  GetJniIdManager()-&gt;Init(self);</span><br><span class="line"></span><br><span class="line">  InitMetrics();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Runtime initialization is largely done now.</span></span><br><span class="line">  <span class="comment">// We load plugins first since that can modify the runtime state slightly.</span></span><br><span class="line">  <span class="comment">// Load all plugins</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// The init method of plugins expect the state of the thread to be non runnable.</span></span><br><span class="line">    ScopedThreadSuspension <span class="title function_">sts</span><span class="params">(self, ThreadState::kNative)</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; plugin : plugins_) &#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> err;</span><br><span class="line">      <span class="keyword">if</span> (!plugin.Load(&amp;err)) &#123;</span><br><span class="line">        LOG(FATAL) &lt;&lt; plugin &lt;&lt; <span class="string">&quot; failed to load: &quot;</span> &lt;&lt; err;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>new gc::Heap(),创建Heap对象，这是虚拟机管理对内存的起点</li>
<li>new JavaVmExt()，创建Java虚拟机实例</li>
<li>Thread::attach(),attach主线程</li>
<li>创建ClassLinker </li>
<li>初始化Classlinker,成功attach到runtime环境后，创建ClassLinker实例负责管理java class</li>
</ol>
<ul>
<li>art&#x2F;runtime&#x2F;thread.cc</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 1009</span></span><br><span class="line">template &lt;typename PeerAction&gt;</span><br><span class="line">Thread* <span class="title function_">Thread::Attach</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* thread_name,</span></span><br><span class="line"><span class="params">                       <span class="type">bool</span> as_daemon,</span></span><br><span class="line"><span class="params">                       PeerAction peer_action,</span></span><br><span class="line"><span class="params">                       <span class="type">bool</span> should_run_callbacks)</span> &#123;</span><br><span class="line">  Runtime* runtime = Runtime::Current();</span><br><span class="line">  ScopedTrace <span class="title function_">trace</span><span class="params">(<span class="string">&quot;Thread::Attach&quot;</span>)</span>;</span><br><span class="line">  <span class="keyword">if</span> (runtime == nullptr) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">&quot;Thread attaching to non-existent runtime: &quot;</span> &lt;&lt;</span><br><span class="line">        ((thread_name != nullptr) ? thread_name : <span class="string">&quot;(Unnamed)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line">  Thread* self;</span><br><span class="line">  &#123;</span><br><span class="line">    ScopedTrace <span class="title function_">trace2</span><span class="params">(<span class="string">&quot;Thread birth&quot;</span>)</span>;</span><br><span class="line">    MutexLock <span class="title function_">mu</span><span class="params">(nullptr, *Locks::runtime_shutdown_lock_)</span>;</span><br><span class="line">    <span class="keyword">if</span> (runtime-&gt;IsShuttingDownLocked()) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; <span class="string">&quot;Thread attaching while runtime is shutting down: &quot;</span> &lt;&lt;</span><br><span class="line">          ((thread_name != nullptr) ? thread_name : <span class="string">&quot;(Unnamed)&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> nullptr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Runtime::Current()-&gt;StartThreadBirth();</span><br><span class="line">      self = new Thread(as_daemon);</span><br><span class="line">      <span class="type">bool</span> init_success = self-&gt;Init(runtime-&gt;GetThreadList(), runtime-&gt;GetJavaVM());</span><br><span class="line">      Runtime::Current()-&gt;EndThreadBirth();</span><br><span class="line">      <span class="keyword">if</span> (!init_success) &#123;</span><br><span class="line">        delete self;</span><br><span class="line">        <span class="keyword">return</span> nullptr;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  self-&gt;InitStringEntryPoints();</span><br><span class="line"></span><br><span class="line">  CHECK_NE(self-&gt;GetState(), ThreadState::kRunnable);</span><br><span class="line">  self-&gt;SetState(ThreadState::kNative);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run the action that is acting on the peer.</span></span><br><span class="line">  <span class="keyword">if</span> (!peer_action(self)) &#123;</span><br><span class="line">    runtime-&gt;GetThreadList()-&gt;Unregister(self, should_run_callbacks);</span><br><span class="line">    <span class="comment">// Unregister deletes self, no need to do this here.</span></span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (VLOG_IS_ON(threads)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (thread_name != nullptr) &#123;</span><br><span class="line">      VLOG(threads) &lt;&lt; <span class="string">&quot;Attaching thread &quot;</span> &lt;&lt; thread_name;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      VLOG(threads) &lt;&lt; <span class="string">&quot;Attaching unnamed thread.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ScopedObjectAccess <span class="title function_">soa</span><span class="params">(self)</span>;</span><br><span class="line">    self-&gt;Dump(LOG_STREAM(INFO));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (should_run_callbacks) &#123;</span><br><span class="line">    ScopedObjectAccess <span class="title function_">soa</span><span class="params">(self)</span>;</span><br><span class="line">    runtime-&gt;GetRuntimeCallbacks()-&gt;ThreadStart(self);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;除了系统的JNI接口(“javacore”,”nativehelper”),android framework还有大量的Native实现，Android将所有这些接口一次性通过startReg()来完成</p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;AndroidRuntime.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Register android native functions with the VM.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*static*/</span> <span class="type">int</span> <span class="title function_">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">&quot;RegisterAndroidNatives&quot;</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This hook causes all future threads created in this process to be</span></span><br><span class="line"><span class="comment">     * attached to the JavaVM.  (This needs to go away in favor of JNI</span></span><br><span class="line"><span class="comment">     * Attach calls.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">&quot;--- registering native functions ---\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Every &quot;register&quot; function calls one or more things that return</span></span><br><span class="line"><span class="comment">     * a local reference (e.g. FindClass).  Because we haven&#x27;t really</span></span><br><span class="line"><span class="comment">     * started the VM yet, they&#x27;re all getting stored in the base frame</span></span><br><span class="line"><span class="comment">     * and never released.  Use Push/Pop to manage the storage.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    env-&gt;PushLocalFrame(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;PopLocalFrame(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//createJavaThread(&quot;fubar&quot;, quickTest, (void*) &quot;hello&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>system&#x2F;core&#x2F;libutils&#x2F;Threads.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 658</span></span><br><span class="line"><span class="type">status_t</span> <span class="title function_">Thread::run</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">int32_t</span> priority, <span class="type">size_t</span> <span class="built_in">stack</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(name == nullptr, <span class="string">&quot;thread name not provided to Thread::run&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mRunning) &#123;</span><br><span class="line">        <span class="comment">// thread already started</span></span><br><span class="line">        <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset status and exitPending to their default value, so we can</span></span><br><span class="line">    <span class="comment">// try again after an error happened (either below, or in readyToRun())</span></span><br><span class="line">    mStatus = OK;</span><br><span class="line">    mExitPending = <span class="literal">false</span>;</span><br><span class="line">    mThread = <span class="type">thread_id_t</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hold a strong reference on ourself</span></span><br><span class="line">    mHoldSelf = sp&lt;Thread&gt;::fromExisting(this);</span><br><span class="line"></span><br><span class="line">    mRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> res;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//android native层有两种Thread的创建方式</span></span><br><span class="line">    <span class="keyword">if</span> (mCanCallJava) &#123;</span><br><span class="line">        res = createThreadEtc(_threadLoop,</span><br><span class="line">                this, name, priority, <span class="built_in">stack</span>, &amp;mThread);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res = androidCreateRawThreadEtc(_threadLoop,</span><br><span class="line">                this, name, priority, <span class="built_in">stack</span>, &amp;mThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">false</span>) &#123;</span><br><span class="line">        mStatus = UNKNOWN_ERROR;   <span class="comment">// something happened!</span></span><br><span class="line">        mRunning = <span class="literal">false</span>;</span><br><span class="line">        mThread = <span class="type">thread_id_t</span>(<span class="number">-1</span>);</span><br><span class="line">        mHoldSelf.clear();  <span class="comment">// &quot;this&quot; may have gone away after this.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not refer to mStatus here: The thread is already running (may, in fact</span></span><br><span class="line">    <span class="comment">// already have exited with a valid mStatus result). The OK indication</span></span><br><span class="line">    <span class="comment">// here merely indicates successfully starting the thread and does not</span></span><br><span class="line">    <span class="comment">// imply successful termination/execution.</span></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exiting scope of mLock is a memory barrier and allows new thread to run</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//line 117</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">androidCreateRawThreadEtc</span><span class="params">(<span class="type">android_thread_func_t</span> entryFunction,</span></span><br><span class="line"><span class="params">                               <span class="type">void</span> *userData,</span></span><br><span class="line"><span class="params">                               <span class="type">const</span> <span class="type">char</span>* threadName __android_unused,</span></span><br><span class="line"><span class="params">                               <span class="type">int32_t</span> threadPriority,</span></span><br><span class="line"><span class="params">                               <span class="type">size_t</span> threadStackSize,</span></span><br><span class="line"><span class="params">                               <span class="type">android_thread_id_t</span> *threadId)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_attr_t</span> attr;</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ANDROID__)  <span class="comment">/* valgrind is rejecting RT-priority create reqs */</span></span></span><br><span class="line">    <span class="keyword">if</span> (threadPriority != PRIORITY_DEFAULT || threadName != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// Now that the pthread_t has a method to find the associated</span></span><br><span class="line">        <span class="comment">// android_thread_id_t (pid) from pthread_t, it would be possible to avoid</span></span><br><span class="line">        <span class="comment">// this trampoline in some cases as the parent could set the properties</span></span><br><span class="line">        <span class="comment">// for the child.  However, there would be a race condition because the</span></span><br><span class="line">        <span class="comment">// child becomes ready immediately, and it doesn&#x27;t work for the name.</span></span><br><span class="line">        <span class="comment">// prctl(PR_SET_NAME) only works for self; prctl(PR_SET_THREAD_NAME) was</span></span><br><span class="line">        <span class="comment">// proposed but not yet accepted.</span></span><br><span class="line">        <span class="type">thread_data_t</span>* t = new <span class="type">thread_data_t</span>;</span><br><span class="line">        t-&gt;priority = threadPriority;</span><br><span class="line">        t-&gt;threadName = threadName ? strdup(threadName) : <span class="literal">NULL</span>;</span><br><span class="line">        t-&gt;entryFunction = entryFunction;</span><br><span class="line">        t-&gt;userData = userData;</span><br><span class="line">        entryFunction = (<span class="type">android_thread_func_t</span>)&amp;<span class="type">thread_data_t</span>::trampoline;</span><br><span class="line">        userData = t;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (threadStackSize) &#123;</span><br><span class="line">        pthread_attr_setstacksize(&amp;attr, threadStackSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">pthread_t</span> thread;</span><br><span class="line">    <span class="type">int</span> resulcreateJavaThreadt = pthread_create(&amp;thread, &amp;attr,</span><br><span class="line">                    (android_pthread_entry)entryFunction, userData);</span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;androidCreateRawThreadEtc failed (entry=%p, res=%d, %s)\n&quot;</span></span><br><span class="line">             <span class="string">&quot;(android threadPriority=%d)&quot;</span>,</span><br><span class="line">            entryFunction, result, strerror(errno), threadPriority);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that *threadID is directly available to the parent only, as it is</span></span><br><span class="line">    <span class="comment">// assigned after the child starts.  Use memory barrier / lock if the child</span></span><br><span class="line">    <span class="comment">// or other threads also need access.</span></span><br><span class="line">    <span class="keyword">if</span> (threadId != nullptr) &#123;</span><br><span class="line">        *threadId = (<span class="type">android_thread_id_t</span>)thread; <span class="comment">// <span class="doctag">XXX:</span> this is not portable</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;android native层有两种Thread的创建方式，它们的区别在是是否能够调用Java端函数，createThreadEtc做了封装。在Android 10上面，这两种方法做了区别，Android 14上面最终都调用了androidCreateRawThreadEtc函数。另外一种方式是javaCreateThreadEtc函数。接着来到java层。</p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;RuntimeInit.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">        preForkInit();</span><br><span class="line">        <span class="keyword">if</span> (argv.length == <span class="number">2</span> &amp;&amp; argv[<span class="number">1</span>].equals(<span class="string">&quot;application&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;RuntimeInit: Starting application&quot;</span>);</span><br><span class="line">            <span class="comment">//将System.out和System.err输出重定向到Android的Log系统(定义在android.util.Log)</span></span><br><span class="line">            redirectLogStreams();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;RuntimeInit: Starting tool&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//commonInit():初始化了一下系统属性，其中最重要的一点就是设置了一个未捕捉异常的handler,当代码有任何未知异常，就会执行它。</span></span><br><span class="line">        commonInit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Now that we&#x27;re running in interpreted code, call back into native code</span></span><br><span class="line"><span class="comment">         * to run the system.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        nativeFinishInit();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;Leaving RuntimeInit!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;AndroidRuntime.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Line 255 nativeFinishInit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Code written in the Java Programming Language calls here from main().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">com_android_internal_os_RuntimeInit_nativeFinishInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span><br><span class="line">&#123;</span><br><span class="line">    gCurRuntime-&gt;onStarted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//line 271</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * JNI registration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">register_com_android_internal_os_RuntimeInit</span><span class="params">(JNIEnv* env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">&quot;nativeFinishInit&quot;</span>, <span class="string">&quot;()V&quot;</span>,</span><br><span class="line">             (<span class="type">void</span>*)com_android_internal_os_RuntimeInit_nativeFinishInit&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;nativeSetExitWithoutCleanup&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>,</span><br><span class="line">             (<span class="type">void</span>*)com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> jniRegisterNativeMethods(env, <span class="string">&quot;com/android/internal/os/RuntimeInit&quot;</span>,</span><br><span class="line">        methods, NELEM(methods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>frameworks&#x2F;base&#x2F;cmds&#x2F;app_process&#x2F;app_main.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 79 ---&gt;  gCurRuntime-&gt;onStarted();</span></span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">onStarted</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">&quot;App process: starting thread pool.\n&quot;</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">        ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ZygoteInit</p>
</li>
<li><p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;ZygoteInit.java</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is the entry point for a Zygote process.  It creates the Zygote server, loads resources,</span></span><br><span class="line"><span class="comment">     * and handles other tasks related to preparing the process for forking into applications.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This process is started with a nice value of -20 (highest priority).  All paths that flow</span></span><br><span class="line"><span class="comment">     * into new processes are required to either set the priority to the default value or terminate</span></span><br><span class="line"><span class="comment">     * before executing any non-system code.  The native side of this occurs in SpecializeCommon,</span></span><br><span class="line"><span class="comment">     * while the Java Language priority is changed in ZygoteInit.handleSystemServerProcess,</span></span><br><span class="line"><span class="comment">     * ZygoteConnection.handleChildProc, and Zygote.childMain.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> argv  Command line arguments used to specify the Zygote&#x27;s configuration.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">        <span class="type">ZygoteServer</span> <span class="variable">zygoteServer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></span><br><span class="line">        <span class="comment">// an error.</span></span><br><span class="line">        ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Store now for StatsLogging later.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isRuntimeRestarted</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>.equals(</span><br><span class="line">                    SystemProperties.get(<span class="string">&quot;sys.boot_completed&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">bootTimeTag</span> <span class="operator">=</span> Process.is64Bit() ? <span class="string">&quot;Zygote64Timing&quot;</span> : <span class="string">&quot;Zygote32Timing&quot;</span>;</span><br><span class="line">            <span class="type">TimingsTraceLog</span> <span class="variable">bootTimingsTraceLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimingsTraceLog</span>(bootTimeTag,</span><br><span class="line">                    Trace.TRACE_TAG_DALVIK);</span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">            RuntimeInit.preForkInit();</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">startSystemServer</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">zygoteSocketName</span> <span class="operator">=</span> <span class="string">&quot;zygote&quot;</span>;<span class="comment">//Dalvik VM进程系统</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">abiList</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">enableLazyPreload</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">                <span class="comment">//这里是app_main.cpp中传递的start-system-server参数</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    startSystemServer = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    enableLazyPreload = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                    zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isPrimaryZygote</span> <span class="operator">=</span> zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line">            <span class="keyword">if</span> (!isRuntimeRestarted) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isPrimaryZygote) &#123;</span><br><span class="line">                    FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                            BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__ZYGOTE_INIT_START,</span><br><span class="line">                            startTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (zygoteSocketName.equals(Zygote.SECONDARY_SOCKET_NAME)) &#123;</span><br><span class="line">                    FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                            BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__SECONDARY_ZYGOTE_INIT_START,</span><br><span class="line">                            startTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abiList == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">            <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">            <span class="comment">// 在有些情况下我们需要在第一个fork之前进行预加载资源</span></span><br><span class="line">            <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">                bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygotePreload&quot;</span>);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                preload(bootTimingsTraceLog);</span><br><span class="line">                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">                bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygotePreload</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class="line">            gcAndFinalize();</span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// PostZygoteInitGC</span></span><br><span class="line"></span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygoteInit</span></span><br><span class="line"></span><br><span class="line">            Zygote.initNativeState(isPrimaryZygote);</span><br><span class="line"></span><br><span class="line">            ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">            zygoteServer = <span class="keyword">new</span> <span class="title class_">ZygoteServer</span>(isPrimaryZygote);<span class="comment">//创建Zygote服务器端</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">                <span class="comment">// child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">            <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;System zygote died with fatal exception&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (zygoteServer != <span class="literal">null</span>) &#123;</span><br><span class="line">                zygoteServer.closeServerSocket();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="literal">null</span>) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// line 137</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">preload</span><span class="params">(TimingsTraceLog bootTimingsTraceLog)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;begin preload&quot;</span>);</span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;BeginPreload&quot;</span>);</span><br><span class="line">        beginPreload();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// BeginPreload</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;PreloadClasses&quot;</span>);</span><br><span class="line">        <span class="comment">//加载指定的类到内存并且初始化，使用的Class.forName(class,ture,null)的方式</span></span><br><span class="line">        preloadClasses();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// PreloadClasses</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;CacheNonBootClasspathClassLoaders&quot;</span>);</span><br><span class="line">        cacheNonBootClasspathClassLoaders();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// CacheNonBootClasspathClassLoaders</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;PreloadResources&quot;</span>);</span><br><span class="line">        <span class="comment">//加载Android 通用的资源，比如drawable</span></span><br><span class="line">        preloadResources();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// PreloadResources</span></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">&quot;PreloadAppProcessHALs&quot;</span>);</span><br><span class="line">        nativePreloadAppProcessHALs();</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="string">&quot;PreloadGraphicsDriver&quot;</span>);</span><br><span class="line">        maybePreloadGraphicsDriver();</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</span><br><span class="line">        preloadSharedLibraries();</span><br><span class="line">        preloadTextResources();</span><br><span class="line">        <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line">        <span class="comment">// for memory sharing purposes.</span></span><br><span class="line">        WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">        endPreload();</span><br><span class="line">        warmUpJcaProviders();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;end preload&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sPreloadComplete = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;preloadClasses将freamwrok.jar里的preloaded-classed定义的所有class load到内存里，preloaded-classes编译Android后可以在framework&#x2F;base下找到。而preloadResource将系统的Resourrce(不是用户apk里定义的resource)load到内存。资源preload到Zygote的进程地址空间，所有fork的子进程将共享这份空间而无需重新load,这大大减少了应用程序的启动时间，但反过来增加了系统的启动时间。通过对preload类和资源数目的进行调整，可以加快系统启动。Preload也是android启动最耗时的部分之一。</p>
<ul>
<li>libcore&#x2F;dalvik&#x2F;src&#x2F;main&#x2F;java&#x2F;dalvik&#x2F;system&#x2F;ZygoteHooks.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line 120</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Runs several special GCs to try to clean up a few generations of</span></span><br><span class="line"><span class="comment">     * softly- and final-reachable objects, along with any other garbage.</span></span><br><span class="line"><span class="comment">     * This is only useful just before a fork().</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SystemApi(client = MODULE_LIBRARIES)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">gcAndFinalize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">VMRuntime</span> <span class="variable">runtime</span> <span class="operator">=</span> VMRuntime.getRuntime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* runFinalizationSync() lets finalizers be called in Zygote,</span></span><br><span class="line"><span class="comment">         * which doesn&#x27;t have a HeapWorker thread.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.gc();</span><br><span class="line">        runtime.runFinalizationSync();</span><br><span class="line">        cleanLocaleCaches();</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;gc()调用只是通知VM进行垃圾回收，是否回收，什么时候回收全由VM内部算法决定。GC的回收有一个复杂的状态机控制，通过多次调用，可以使得尽可能多的资源得到回收。gc()必须在fork之前完成(接下来的StatSystemServer就会有fork操作)，这样将来被复制出来的子进程才能有尽可能少的垃圾内存没有释放。</p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;ZygoteInit.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prepare the arguments and forks for the system server process.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A &#123;<span class="doctag">@code</span> Runnable&#125; that provides an entrypoint into system_server code in the child</span></span><br><span class="line"><span class="comment">     * process; &#123;<span class="doctag">@code</span> null&#125; in the parent.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title function_">forkSystemServer</span><span class="params">(String abiList, String socketName,</span></span><br><span class="line"><span class="params">            ZygoteServer zygoteServer)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">capabilities</span> <span class="operator">=</span> posixCapabilitiesAsBits(</span><br><span class="line">                OsConstants.CAP_IPC_LOCK,</span><br><span class="line">                OsConstants.CAP_KILL,</span><br><span class="line">                OsConstants.CAP_NET_ADMIN,</span><br><span class="line">                OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">                OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">                OsConstants.CAP_NET_RAW,</span><br><span class="line">                OsConstants.CAP_SYS_MODULE,</span><br><span class="line">                OsConstants.CAP_SYS_NICE,</span><br><span class="line">                OsConstants.CAP_SYS_PTRACE,</span><br><span class="line">                OsConstants.CAP_SYS_TIME,</span><br><span class="line">                OsConstants.CAP_SYS_TTY_CONFIG,</span><br><span class="line">                OsConstants.CAP_WAKE_ALARM,</span><br><span class="line">                OsConstants.CAP_BLOCK_SUSPEND</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">/* Containers run without some capabilities, so drop any caps that are not available. */</span></span><br><span class="line">        <span class="type">StructCapUserHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StructCapUserHeader</span>(</span><br><span class="line">                OsConstants._LINUX_CAPABILITY_VERSION_3, <span class="number">0</span>);</span><br><span class="line">        StructCapUserData[] data;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data = Os.capget(header);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to capget()&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        capabilities &amp;= Integer.toUnsignedLong(data[<span class="number">0</span>].effective) |</span><br><span class="line">                (Integer.toUnsignedLong(data[<span class="number">1</span>].effective) &lt;&lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Hardcoded command line to start the system server */</span></span><br><span class="line">        <span class="comment">//启动SystemServer的命令行，部分参数写死</span></span><br><span class="line">        String[] args = &#123;</span><br><span class="line">                <span class="string">&quot;--setuid=1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--setgid=1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&quot;</span></span><br><span class="line">                        + <span class="string">&quot;1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--capabilities=&quot;</span> + capabilities + <span class="string">&quot;,&quot;</span> + capabilities,</span><br><span class="line">                <span class="string">&quot;--nice-name=system_server&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--runtime-args&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--target-sdk-version=&quot;</span> + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT,</span><br><span class="line">                <span class="string">&quot;com.android.server.SystemServer&quot;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        ZygoteArguments parsedArgs;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> pid;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ZygoteCommandBuffer</span> <span class="variable">commandBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZygoteCommandBuffer</span>(args);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                parsedArgs = ZygoteArguments.getInstance(commandBuffer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (EOFException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Unexpected argument error for forking system server&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            commandBuffer.close();</span><br><span class="line">            Zygote.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">            Zygote.applyInvokeWithSystemProperty(parsedArgs);<span class="comment">//会设置InvokeWith参数，这个参数在接下来的初始化逻辑中会有调用</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Zygote.nativeSupportsMemoryTagging()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">mode</span> <span class="operator">=</span> SystemProperties.get(<span class="string">&quot;persist.arm64.memtag.system_server&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (mode.isEmpty()) &#123;</span><br><span class="line">                  <span class="comment">/* The system server has ASYNC MTE by default, in order to allow</span></span><br><span class="line"><span class="comment">                   * system services to specify their own MTE level later, as you</span></span><br><span class="line"><span class="comment">                   * can&#x27;t re-enable MTE once it&#x27;s disabled. */</span></span><br><span class="line">                  mode = SystemProperties.get(<span class="string">&quot;persist.arm64.memtag.default&quot;</span>, <span class="string">&quot;async&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mode.equals(<span class="string">&quot;async&quot;</span>)) &#123;</span><br><span class="line">                    parsedArgs.mRuntimeFlags |= Zygote.MEMORY_TAG_LEVEL_ASYNC;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode.equals(<span class="string">&quot;sync&quot;</span>)) &#123;</span><br><span class="line">                    parsedArgs.mRuntimeFlags |= Zygote.MEMORY_TAG_LEVEL_SYNC;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mode.equals(<span class="string">&quot;off&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* When we have an invalid memory tag level, keep the current level. */</span></span><br><span class="line">                    parsedArgs.mRuntimeFlags |= Zygote.nativeCurrentTaggingLevel();</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Unknown memory tag level for the system server: \&quot;&quot;</span> + mode + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Zygote.nativeSupportsTaggedPointers()) &#123;</span><br><span class="line">                <span class="comment">/* Enable pointer tagging in the system server. Hardware support for this is present</span></span><br><span class="line"><span class="comment">                 * in all ARMv8 CPUs. */</span></span><br><span class="line">                parsedArgs.mRuntimeFlags |= Zygote.MEMORY_TAG_LEVEL_TBI;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Enable gwp-asan on the system server with a small probability. This is the same</span></span><br><span class="line"><span class="comment">             * policy as applied to native processes and system apps. */</span></span><br><span class="line">            parsedArgs.mRuntimeFlags |= Zygote.GWP_ASAN_LEVEL_LOTTERY;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (shouldProfileSystemServer()) &#123;</span><br><span class="line">                parsedArgs.mRuntimeFlags |= Zygote.PROFILE_SYSTEM_SERVER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 创建System server 进程 */</span></span><br><span class="line">            pid = Zygote.forkSystemServer(</span><br><span class="line">                    parsedArgs.mUid, parsedArgs.mGid,</span><br><span class="line">                    parsedArgs.mGids,</span><br><span class="line">                    parsedArgs.mRuntimeFlags,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    parsedArgs.mPermittedCapabilities,</span><br><span class="line">                    parsedArgs.mEffectiveCapabilities);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* For child process */</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;<span class="comment">//如果是第一次创建的话 pid == 0</span></span><br><span class="line">            <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">                waitForSecondaryZygote(socketName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">            <span class="keyword">return</span> handleSystemServerProcess(parsedArgs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;ZygoteInit.forkSystemServer()方法fork出SystemServer进程。fork出来的子进程在handleSystemServerProcess里开始初始化工作，主要工作分为：</p>
<ol>
<li>prepareSystemServerProfile()方法中将SYSTEMSERVERCLASSPATH中的AppInfo加载到VM中</li>
<li>判断fork args中是否有invokWith参数，如果有则进行WrapperInit.execApplication</li>
</ol>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;ZygoteInit.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//Line 524</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finish remaining work for the newly forked system server process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title function_">handleSystemServerProcess</span><span class="params">(ZygoteArguments parsedArgs)</span> &#123;</span><br><span class="line">        <span class="comment">// set umask to 0077 so new files and directories will default to owner-only permissions.</span></span><br><span class="line">        Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.mNiceName != <span class="literal">null</span>) &#123;</span><br><span class="line">            Process.setArgV0(parsedArgs.mNiceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">systemServerClasspath</span> <span class="operator">=</span> Os.getenv(<span class="string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Capturing profiles is only supported for debug or eng builds since selinux normally</span></span><br><span class="line">            <span class="comment">// prevents it.</span></span><br><span class="line">            <span class="keyword">if</span> (shouldProfileSystemServer() &amp;&amp; (Build.IS_USERDEBUG || Build.IS_ENG)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Preparing system server profile&quot;</span>);</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">standaloneSystemServerJars</span> <span class="operator">=</span></span><br><span class="line">                            Os.getenv(<span class="string">&quot;STANDALONE_SYSTEMSERVER_JARS&quot;</span>);</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">systemServerPaths</span> <span class="operator">=</span> standaloneSystemServerJars != <span class="literal">null</span></span><br><span class="line">                            ? String.join(<span class="string">&quot;:&quot;</span>, systemServerClasspath, standaloneSystemServerJars)</span><br><span class="line">                            : systemServerClasspath;</span><br><span class="line">                    <span class="comment">//将SYSTEMSERVERCLASSPATH中的AppInfo加载到VM中</span></span><br><span class="line">                    prepareSystemServerProfile(systemServerPaths);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.wtf(TAG, <span class="string">&quot;Failed to set up system server profile&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.mInvokeWith != <span class="literal">null</span>) &#123;</span><br><span class="line">            String[] args = parsedArgs.mRemainingArgs;</span><br><span class="line">            <span class="comment">// If we have a non-null system server class path, we&#x27;ll have to duplicate the</span></span><br><span class="line">            <span class="comment">// existing arguments and append the classpath to it. ART will handle the classpath</span></span><br><span class="line">            <span class="comment">// correctly when we exec a new process.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断fork args中是否有invokWith参数，如果有则进行WrapperInit.execApplication</span></span><br><span class="line">            <span class="keyword">if</span> (systemServerClasspath != <span class="literal">null</span>) &#123;</span><br><span class="line">                String[] amendedArgs = <span class="keyword">new</span> <span class="title class_">String</span>[args.length + <span class="number">2</span>];</span><br><span class="line">                amendedArgs[<span class="number">0</span>] = <span class="string">&quot;-cp&quot;</span>;</span><br><span class="line">                amendedArgs[<span class="number">1</span>] = systemServerClasspath;</span><br><span class="line">                System.arraycopy(args, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, args.length);</span><br><span class="line">                args = amendedArgs;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WrapperInit.execApplication(parsedArgs.mInvokeWith,</span><br><span class="line">                    parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,</span><br><span class="line">                    VMRuntime.getCurrentInstructionSet(), <span class="literal">null</span>, args);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unexpected return from WrapperInit.execApplication&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> getOrCreateSystemServerClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">                Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Pass the remaining arguments to SystemServer.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                    parsedArgs.mDisabledCompatChanges,</span><br><span class="line">                    parsedArgs.mRemainingArgs, cl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* should never reach here */</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;RuntimeInit.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//line296</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invokes a static &quot;main(argv[]) method on class &quot;className&quot;.</span></span><br><span class="line"><span class="comment">     * Converts various failing exceptions into RuntimeExceptions, with</span></span><br><span class="line"><span class="comment">     * the assumption that they will then cause the VM instance to exit.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className Fully-qualified class name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> argv Argument vector for main()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader the classLoader to load &#123;<span class="doctag">@className</span>&#125; with</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title function_">findStaticMain</span><span class="params">(String className, String[] argv,</span></span><br><span class="line"><span class="params">            ClassLoader classLoader)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cl = Class.forName(className, <span class="literal">true</span>, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Missing class when invoking static main &quot;</span> + className,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method m;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String[].class &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Missing static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Problem getting static main on &quot;</span> + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">modifiers</span> <span class="operator">=</span> m.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Main method is not public and static on &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This throw gets caught in ZygoteInit.main(), which responds</span></span><br><span class="line"><span class="comment">         * by invoking the exception&#x27;s run() method. This arrangement</span></span><br><span class="line"><span class="comment">         * clears up all the stack frames that were required in setting</span></span><br><span class="line"><span class="comment">         * up the process.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodAndArgsCaller</span>(m, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper class which holds a method and arguments and can call them. This is used as part of</span></span><br><span class="line"><span class="comment">     * a trampoline to get rid of the initial process setup stack frames.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="comment">/** method to call */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** argument array */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> &#123;</span><br><span class="line">            mMethod = method;</span><br><span class="line">            mArgs = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMethod.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; mArgs &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> ex.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;很明显这是一个耗时操作所以使用线程来完成</p>
<h4 id="System-Servver启动流程"><a href="#System-Servver启动流程" class="headerlink" title="System Servver启动流程"></a>System Servver启动流程</h4><p>&emsp;&emsp;System Server是Zygote fork的第一个Java进程，这个进程非常重要，因为他们有很多的系统线程，提供所有和信心的系统服务，比如WindowManager,ActivityManager,它们都是运行在system_server的进程中。还有很多“Binder-x”的线程，它们是各个Service为了响应应用程序远程调用请求而创建的。除此之外，还有很多内部线程，比如”UI thread”, “InputReader”,”InputDispatch”等等。现在着重看System Server是如何创建起来的。</p>
<p>&emsp;&emsp;分成4部分详细分析SystemServer().run()方法的初始化流程，初始化必要的SystemServer环境参数，比如系统时间、默认时区、语言、Load一些Library等等，初始化Looper,我们在主线程中使用到的looper就是在SystemServer中进行初始化的，初始化Context，只有初始化一个Context才能进行启动Service等操作。</p>
<ul>
<li>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The main entry point from zygote.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SystemServer</span>().run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//line 1044</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createSystemContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ActivityThread</span> <span class="variable">activityThread</span> <span class="operator">=</span> ActivityThread.systemMain();</span><br><span class="line">        mSystemContext = activityThread.getSystemContext();</span><br><span class="line">        mSystemContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">systemUiContext</span> <span class="operator">=</span> activityThread.getSystemUiContext();</span><br><span class="line">        systemUiContext.setTheme(DEFAULT_SYSTEM_THEME);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;继续看ActivityThread中如何生成Context:</p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;app&#x2F;ActivityThread.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">public</span> ContextImpl <span class="title function_">getSystemContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSystemContext == <span class="literal">null</span>) &#123;</span><br><span class="line">            mSystemContext = ContextImpl.createSystemContext(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mSystemContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;ContextImpl是Cotext类的具体实现，里面封装完成生成几种常用的createContext的方法:</p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;app&#x2F;ContextImpl.java<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">static</span> ContextImpl <span class="title function_">createSystemContext</span><span class="params">(ActivityThread mainThread)</span> &#123;</span><br><span class="line">        <span class="type">LoadedApk</span> <span class="variable">packageInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoadedApk</span>(mainThread);</span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextImpl</span>(<span class="literal">null</span>, mainThread, packageInfo,</span><br><span class="line">                ContextParams.EMPTY, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        context.setResources(packageInfo.getResources());</span><br><span class="line">        context.mResources.updateConfiguration(context.mResourcesManager.getConfiguration(),</span><br><span class="line">                context.mResourcesManager.getDisplayMetrics());</span><br><span class="line">        context.mContextType = CONTEXT_TYPE_SYSTEM_OR_SYSTEM_UI;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * System Context to be used for UI. This Context has resources that can be themed.</span></span><br><span class="line"><span class="comment">     * Make sure that the created system UI context shares the same LoadedApk as the system context.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> systemContext The system context which created by</span></span><br><span class="line"><span class="comment">     *                      &#123;<span class="doctag">@link</span> #createSystemContext(ActivityThread)&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> displayId The ID of the display where the UI is shown.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> ContextImpl <span class="title function_">createSystemUiContext</span><span class="params">(ContextImpl systemContext, <span class="type">int</span> displayId)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">WindowTokenClient</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WindowTokenClient</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> systemContext.createWindowContextBase(token, displayId);</span><br><span class="line">        token.attachContext(context);</span><br><span class="line">        token.attachToDisplayContent(displayId);</span><br><span class="line">        context.mContextType = CONTEXT_TYPE_SYSTEM_OR_SYSTEM_UI;</span><br><span class="line">        context.mOwnsToken = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">static</span> ContextImpl <span class="title function_">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createAppContext(mainThread, packageInfo, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ContextImpl <span class="title function_">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo,</span></span><br><span class="line"><span class="params">            String opPackageName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageInfo == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;packageInfo&quot;</span>);</span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextImpl</span>(<span class="literal">null</span>, mainThread, packageInfo,</span><br><span class="line">            ContextParams.EMPTY, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="literal">null</span>, opPackageName);</span><br><span class="line">        context.setResources(packageInfo.getResources());</span><br><span class="line">        context.mContextType = isSystemOrSystemUI(context) ? CONTEXT_TYPE_SYSTEM_OR_SYSTEM_UI</span><br><span class="line">                : CONTEXT_TYPE_NON_UI;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553)</span></span><br><span class="line">    <span class="keyword">static</span> ContextImpl <span class="title function_">createActivityContext</span><span class="params">(ActivityThread mainThread,</span></span><br><span class="line"><span class="params">            LoadedApk packageInfo, ActivityInfo activityInfo, IBinder activityToken, <span class="type">int</span> displayId,</span></span><br><span class="line"><span class="params">            Configuration overrideConfiguration)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageInfo == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;packageInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] splitDirs = packageInfo.getSplitResDirs();</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> packageInfo.getClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (packageInfo.getApplicationInfo().requestsIsolatedSplitLoading()) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, <span class="string">&quot;SplitDependencies&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                classLoader = packageInfo.getSplitClassLoader(activityInfo.splitName);</span><br><span class="line">                splitDirs = packageInfo.getSplitPaths(activityInfo.splitName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Nothing above us can handle a NameNotFoundException, better crash.</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String attributionTag;</span><br><span class="line">        <span class="keyword">if</span> (activityInfo.attributionTags != <span class="literal">null</span> &amp;&amp; activityInfo.attributionTags.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            attributionTag = activityInfo.attributionTags[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            attributionTag = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextImpl</span>(<span class="literal">null</span>, mainThread, packageInfo, ContextParams.EMPTY,</span><br><span class="line">                attributionTag, <span class="literal">null</span>, activityInfo.splitName, activityToken, <span class="literal">null</span>, <span class="number">0</span>, classLoader,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">        context.mContextType = CONTEXT_TYPE_ACTIVITY;</span><br><span class="line">        context.mIsConfigurationBasedContext = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clamp display ID to DEFAULT_DISPLAY if it is INVALID_DISPLAY.</span></span><br><span class="line">        displayId = (displayId != Display.INVALID_DISPLAY) ? displayId : Display.DEFAULT_DISPLAY;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CompatibilityInfo</span> <span class="variable">compatInfo</span> <span class="operator">=</span> (displayId == Display.DEFAULT_DISPLAY)</span><br><span class="line">                ? packageInfo.getCompatibilityInfo()</span><br><span class="line">                : CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ResourcesManager</span> <span class="variable">resourcesManager</span> <span class="operator">=</span> ResourcesManager.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the base resources for which all configuration contexts for this Activity</span></span><br><span class="line">        <span class="comment">// will be rebased upon.</span></span><br><span class="line">        context.setResources(resourcesManager.createBaseTokenResources(activityToken,</span><br><span class="line">                packageInfo.getResDir(),</span><br><span class="line">                splitDirs,</span><br><span class="line">                packageInfo.getOverlayDirs(),</span><br><span class="line">                packageInfo.getOverlayPaths(),</span><br><span class="line">                packageInfo.getApplicationInfo().sharedLibraryFiles,</span><br><span class="line">                displayId,</span><br><span class="line">                overrideConfiguration,</span><br><span class="line">                compatInfo,</span><br><span class="line">                classLoader,</span><br><span class="line">                packageInfo.getApplication() == <span class="literal">null</span> ? <span class="literal">null</span></span><br><span class="line">                        : packageInfo.getApplication().getResources().getLoaders()));</span><br><span class="line">        context.setDisplay(resourcesManager.getAdjustedDisplay(</span><br><span class="line">                displayId, context.getResources()));</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>&emsp;&emsp;初始化SystemServiceManager,用来管理启动service,SystemServiceManager中封装了启动Service的startService方法启动系统必要的Service,启动service的流程分为三步：</p>
<ul>
<li>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TimingsTraceAndSlog</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimingsTraceAndSlog</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.traceBegin(<span class="string">&quot;InitBeforeStartServices&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Record the process start information in sys props.</span></span><br><span class="line">            SystemProperties.set(SYSPROP_START_COUNT, String.valueOf(mStartCount));</span><br><span class="line">            SystemProperties.set(SYSPROP_START_ELAPSED, String.valueOf(mRuntimeStartElapsedTime));</span><br><span class="line">            SystemProperties.set(SYSPROP_START_UPTIME, String.valueOf(mRuntimeStartUptime));</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.SYSTEM_SERVER_START,</span><br><span class="line">                    mStartCount, mRuntimeStartUptime, mRuntimeStartElapsedTime);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the device&#x27;s time zone (a system property) if it is not set or is invalid.</span></span><br><span class="line">            SystemTimeZone.initializeTimeZoneSettingsIfRequired();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the system has &quot;persist.sys.language&quot; and friends set, replace them with</span></span><br><span class="line">            <span class="comment">// &quot;persist.sys.locale&quot;. Note that the default locale at this point is calculated</span></span><br><span class="line">            <span class="comment">// using the &quot;-Duser.locale&quot; command line flag. That flag is usually populated by</span></span><br><span class="line">            <span class="comment">// AndroidRuntime using the same set of system properties, but only the system_server</span></span><br><span class="line">            <span class="comment">// and system apps are allowed to set them.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> Most changes made here will need an equivalent change to</span></span><br><span class="line">            <span class="comment">// core/jni/AndroidRuntime.cpp</span></span><br><span class="line">            <span class="keyword">if</span> (!SystemProperties.get(<span class="string">&quot;persist.sys.language&quot;</span>).isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">languageTag</span> <span class="operator">=</span> Locale.getDefault().toLanguageTag();</span><br><span class="line"></span><br><span class="line">                SystemProperties.set(<span class="string">&quot;persist.sys.locale&quot;</span>, languageTag);</span><br><span class="line">                SystemProperties.set(<span class="string">&quot;persist.sys.language&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                SystemProperties.set(<span class="string">&quot;persist.sys.country&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                SystemProperties.set(<span class="string">&quot;persist.sys.localevar&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The system server should never make non-oneway calls</span></span><br><span class="line">            Binder.setWarnOnBlocking(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// The system server should always load safe labels</span></span><br><span class="line">            PackageItemInfo.forceSafeLabels();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Default to FULL within the system server.</span></span><br><span class="line">            SQLiteGlobal.sDefaultSyncMode = SQLiteGlobal.SYNC_MODE_FULL;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Deactivate SQLiteCompatibilityWalFlags until settings provider is initialized</span></span><br><span class="line">            SQLiteCompatibilityWalFlags.init(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Here we go!</span></span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">uptimeMillis</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);</span><br><span class="line">            <span class="keyword">if</span> (!mRuntimeRestart) &#123;</span><br><span class="line">                FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                        FrameworkStatsLog</span><br><span class="line">                                .BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__SYSTEM_SERVER_INIT_START,</span><br><span class="line">                        uptimeMillis);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// In case the runtime switched since last boot (such as when</span></span><br><span class="line">            <span class="comment">// the old runtime was removed in an OTA), set the system</span></span><br><span class="line">            <span class="comment">// property so that it is in sync. We can&#x27;t do this in</span></span><br><span class="line">            <span class="comment">// libnativehelper&#x27;s JniInvocation::Init code where we already</span></span><br><span class="line">            <span class="comment">// had to fallback to a different runtime because it is</span></span><br><span class="line">            <span class="comment">// running as root and we need to be the system user to set</span></span><br><span class="line">            <span class="comment">// the property. http://b/11463182</span></span><br><span class="line">            SystemProperties.set(<span class="string">&quot;persist.sys.dalvik.vm.lib.2&quot;</span>, VMRuntime.getRuntime().vmLibrary());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line">            VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Some devices rely on runtime fingerprint generation, so make sure</span></span><br><span class="line">            <span class="comment">// we&#x27;ve defined it before booting further.</span></span><br><span class="line">            Build.ensureFingerprintProperty();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, it is an error to access Environment paths without</span></span><br><span class="line">            <span class="comment">// explicitly specifying a user.</span></span><br><span class="line">            Environment.setUserRequired(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, any incoming Bundles should be defused</span></span><br><span class="line">            <span class="comment">// to avoid throwing BadParcelableException.</span></span><br><span class="line">            BaseBundle.setShouldDefuse(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Within the system server, when parceling exceptions, include the stack trace</span></span><br><span class="line">            Parcel.setStackTraceParceling(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure binder calls into the system always run at foreground priority.</span></span><br><span class="line">            BinderInternal.disableBackgroundScheduling(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Increase the number of binder threads in system_server</span></span><br><span class="line">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare the main looper thread (this thread).</span></span><br><span class="line">            android.os.Process.setThreadPriority(</span><br><span class="line">                    android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">            android.os.Process.setCanSelfBackground(<span class="literal">false</span>);</span><br><span class="line">            Looper.prepareMainLooper();</span><br><span class="line">            Looper.getMainLooper().setSlowLogThresholdMs(</span><br><span class="line">                    SLOW_DISPATCH_THRESHOLD_MS, SLOW_DELIVERY_THRESHOLD_MS);</span><br><span class="line"></span><br><span class="line">            SystemServiceRegistry.sEnableServiceNotFoundWtf = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize native services.</span></span><br><span class="line">            System.loadLibrary(<span class="string">&quot;android_servers&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Allow heap / perf profiling.</span></span><br><span class="line">            initZygoteChildHeapProfiling();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Debug builds - spawn a thread to monitor for fd leaks.</span></span><br><span class="line">            <span class="keyword">if</span> (Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">                spawnFdLeakCheckThread();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check whether we failed to shut down last time we tried.</span></span><br><span class="line">            <span class="comment">// This call may not return.</span></span><br><span class="line">            performPendingShutdown();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize the system context.</span></span><br><span class="line">            createSystemContext();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call per-process mainline module initialization.</span></span><br><span class="line">            ActivityThread.initializeMainlineModules();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Sets the dumper service</span></span><br><span class="line">            ServiceManager.addService(<span class="string">&quot;system_server_dumper&quot;</span>, mDumper);</span><br><span class="line">            mDumper.addDumpable(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create the system service manager.</span></span><br><span class="line">            mSystemServiceManager = <span class="keyword">new</span> <span class="title class_">SystemServiceManager</span>(mSystemContext);</span><br><span class="line">            mSystemServiceManager.setStartInfo(mRuntimeRestart,</span><br><span class="line">                    mRuntimeStartElapsedTime, mRuntimeStartUptime);</span><br><span class="line">            mDumper.addDumpable(mSystemServiceManager);</span><br><span class="line"></span><br><span class="line">            LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">            <span class="comment">// Prepare the thread pool for init tasks that can be parallelized</span></span><br><span class="line">            <span class="type">SystemServerInitThreadPool</span> <span class="variable">tp</span> <span class="operator">=</span> SystemServerInitThreadPool.start();</span><br><span class="line">            mDumper.addDumpable(tp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Load preinstalled system fonts for system server, so that WindowManagerService, etc</span></span><br><span class="line">            <span class="comment">// can start using Typeface. Note that fonts are required not only for text rendering,</span></span><br><span class="line">            <span class="comment">// but also for some text operations (e.g. TextUtils.makeSafeForPresentation()).</span></span><br><span class="line">            <span class="keyword">if</span> (Typeface.ENABLE_LAZY_TYPEFACE_INITIALIZATION) &#123;</span><br><span class="line">                Typeface.loadPreinstalledSystemFontMap();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Attach JVMTI agent if this is a debuggable build and the system property is set.</span></span><br><span class="line">            <span class="keyword">if</span> (Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">                <span class="comment">// Property is of the form &quot;library_path=parameters&quot;.</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">jvmtiAgent</span> <span class="operator">=</span> SystemProperties.get(<span class="string">&quot;persist.sys.dalvik.jvmtiagent&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!jvmtiAgent.isEmpty()) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">equalIndex</span> <span class="operator">=</span> jvmtiAgent.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">libraryPath</span> <span class="operator">=</span> jvmtiAgent.substring(<span class="number">0</span>, equalIndex);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">parameterList</span> <span class="operator">=</span></span><br><span class="line">                            jvmtiAgent.substring(equalIndex + <span class="number">1</span>, jvmtiAgent.length());</span><br><span class="line">                    <span class="comment">// Attach the agent.</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Debug.attachJvmtiAgent(libraryPath, parameterList, <span class="literal">null</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;*************************************************&quot;</span>);</span><br><span class="line">                        Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;********** Failed to load jvmti plugin: &quot;</span> + jvmtiAgent);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            t.traceEnd();  <span class="comment">// InitBeforeStartServices</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Setup the default WTF handler</span></span><br><span class="line">        RuntimeInit.setDefaultApplicationWtfHandler(SystemServer::handleEarlySystemWtf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start services.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t.traceBegin(<span class="string">&quot;StartServices&quot;</span>);</span><br><span class="line">            startBootstrapServices(t);</span><br><span class="line">            startCoreServices(t);</span><br><span class="line">            startOtherServices(t);</span><br><span class="line">            startApexServices(t);</span><br><span class="line">            <span class="comment">// Only update the timeout after starting all the services so that we use</span></span><br><span class="line">            <span class="comment">// the default timeout to start system server.</span></span><br><span class="line">            updateWatchdogTimeout(t);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting system services&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            t.traceEnd(); <span class="comment">// StartServices</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StrictMode.initVmDefaults(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mRuntimeRestart &amp;&amp; !isFirstBootOrUpgrade()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">uptimeMillis</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">            FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                    FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__SYSTEM_SERVER_READY,</span><br><span class="line">                    uptimeMillis);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxUptimeMillis</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (uptimeMillis &gt; maxUptimeMillis) &#123;</span><br><span class="line">                Slog.wtf(SYSTEM_SERVER_TIMING_TAG,</span><br><span class="line">                        <span class="string">&quot;SystemServer init took too long. uptimeMillis=&quot;</span> + uptimeMillis);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Loop forever.</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;启动BootstrapServices,就是系统必须需要的服务，这些服务直接耦合性很高，所以干脆就放在一个方法里面一起启动，比如PowerManagerService、RecoverySystemService、DisplayManagerService、UsageStatsService、WebViewUpdateService启动其他需要用到的Service,比如NetworkScoreService、AlarmManagerService。</p>
<p>&emsp;&emsp;Zygote还有善后工作，一旦发现System Server挂掉了，将其回收，然后将自己杀掉，重新开始新的一生。  </p>
<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;internal&#x2F;os&#x2F;Zygote.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Special method to start the system server process. In addition to the</span></span><br><span class="line"><span class="comment">     * common actions performed in forkAndSpecialize, the pid of the child</span></span><br><span class="line"><span class="comment">     * process is recorded such that the death of the child process will cause</span></span><br><span class="line"><span class="comment">     * zygote to exit.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid the UNIX uid that the new process should setuid() to after</span></span><br><span class="line"><span class="comment">     * fork()ing and and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gid the UNIX gid that the new process should setgid() to after</span></span><br><span class="line"><span class="comment">     * fork()ing and and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gids null-ok; a list of UNIX gids that the new process should</span></span><br><span class="line"><span class="comment">     * setgroups() to after fork and before spawning any threads.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runtimeFlags bit flags that enable ART features.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rlimits null-ok an array of rlimit tuples, with the second</span></span><br><span class="line"><span class="comment">     * dimension having a length of 3 and representing</span></span><br><span class="line"><span class="comment">     * (resource, rlim_cur, rlim_max). These are set via the posix</span></span><br><span class="line"><span class="comment">     * setrlimit(2) call.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> permittedCapabilities argument for setcap()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> effectiveCapabilities argument for setcap()</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 0 if this is the child, pid of the child</span></span><br><span class="line"><span class="comment">     * if this is the parent, or -1 on error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">forkSystemServer</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> gid, <span class="type">int</span>[] gids, <span class="type">int</span> runtimeFlags,</span></span><br><span class="line"><span class="params">            <span class="type">int</span>[][] rlimits, <span class="type">long</span> permittedCapabilities, <span class="type">long</span> effectiveCapabilities)</span> &#123;</span><br><span class="line">        ZygoteHooks.preFork();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> nativeForkSystemServer(</span><br><span class="line">                uid, gid, gids, runtimeFlags, rlimits,</span><br><span class="line">                permittedCapabilities, effectiveCapabilities);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the Java Language thread priority to the default value for new apps.</span></span><br><span class="line">        Thread.currentThread().setPriority(Thread.NORM_PRIORITY);</span><br><span class="line"></span><br><span class="line">        ZygoteHooks.postForkCommon();</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">nativeForkSystemServer</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> gid, <span class="type">int</span>[] gids, <span class="type">int</span> runtimeFlags,</span></span><br><span class="line"><span class="params">            <span class="type">int</span>[][] rlimits, <span class="type">long</span> permittedCapabilities, <span class="type">long</span> effectiveCapabilities)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>frameworks&#x2F;base&#x2F;core&#x2F;jni&#x2F;com_android_internal_os_Zygote.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//line 2405</span></span><br><span class="line"></span><br><span class="line">NO_STACK_PROTECTOR</span><br><span class="line"><span class="type">static</span> jint <span class="title function_">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span></span><br><span class="line"><span class="params">        JNIEnv* env, jclass, <span class="type">uid_t</span> uid, <span class="type">gid_t</span> gid, jintArray gids,</span></span><br><span class="line"><span class="params">        jint runtime_flags, jobjectArray rlimits, jlong permitted_capabilities,</span></span><br><span class="line"><span class="params">        jlong effective_capabilities)</span> &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; <span class="title function_">fds_to_close</span><span class="params">(MakeUsapPipeReadFDVector())</span>,</span><br><span class="line">                   <span class="title function_">fds_to_ignore</span><span class="params">(fds_to_close)</span>;</span><br><span class="line"></span><br><span class="line">  fds_to_close.push_back(gUsapPoolSocketFD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gUsapPoolEventFD != <span class="number">-1</span>) &#123;</span><br><span class="line">    fds_to_close.push_back(gUsapPoolEventFD);</span><br><span class="line">    fds_to_ignore.push_back(gUsapPoolEventFD);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gSystemServerSocketFd != <span class="number">-1</span>) &#123;</span><br><span class="line">      fds_to_close.push_back(gSystemServerSocketFd);</span><br><span class="line">      fds_to_ignore.push_back(gSystemServerSocketFd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">pid_t</span> pid = zygote::ForkCommon(env, <span class="literal">true</span>,</span><br><span class="line">                                 fds_to_close,</span><br><span class="line">                                 fds_to_ignore,</span><br><span class="line">                                 <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// System server prcoess does not need data isolation so no need to</span></span><br><span class="line">      <span class="comment">// know pkg_data_info_list.</span></span><br><span class="line">      SpecializeCommon(env, uid, gid, gids, runtime_flags, rlimits, permitted_capabilities,</span><br><span class="line">                       effective_capabilities, MOUNT_EXTERNAL_DEFAULT, nullptr, nullptr, <span class="literal">true</span>,</span><br><span class="line">                       <span class="literal">false</span>, nullptr, nullptr, <span class="comment">/* is_top_app= */</span> <span class="literal">false</span>,</span><br><span class="line">                       <span class="comment">/* pkg_data_info_list */</span> nullptr,</span><br><span class="line">                       <span class="comment">/* allowlisted_data_info_list */</span> nullptr, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// The zygote process checks whether the child process has died or not.</span></span><br><span class="line">      ALOGI(<span class="string">&quot;System server process %d has been created&quot;</span>, pid);</span><br><span class="line">      gSystemServerPid = pid;</span><br><span class="line">      <span class="comment">// There is a slight window that the system server process has crashed</span></span><br><span class="line">      <span class="comment">// but it went unnoticed because we haven&#x27;t published its pid yet. So</span></span><br><span class="line">      <span class="comment">// we recheck here just to make sure that all is well.</span></span><br><span class="line">      <span class="comment">// WNOHANG会让waitpid立即返回，这里只是为预防上面的赋值语句没有完成之前SystemServer就crash了</span></span><br><span class="line"></span><br><span class="line">      <span class="type">int</span> status;</span><br><span class="line">      <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">          ALOGE(<span class="string">&quot;System server process %d has died. Restarting Zygote!&quot;</span>, pid);</span><br><span class="line">          RuntimeAbort(env, __LINE__, <span class="string">&quot;System server process has died. Restarting Zygote!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (UsePerAppMemcg()) &#123;</span><br><span class="line">          <span class="comment">// Assign system_server to the correct memory cgroup.</span></span><br><span class="line">          <span class="comment">// Not all devices mount memcg so check if it is mounted first</span></span><br><span class="line">          <span class="comment">// to avoid unnecessarily printing errors and denials in the logs.</span></span><br><span class="line">          <span class="keyword">if</span> (!SetTaskProfiles(pid, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&#123;<span class="string">&quot;SystemMemoryProcess&quot;</span>&#125;)) &#123;</span><br><span class="line">              ALOGE(<span class="string">&quot;couldn&#x27;t add process %d into system memcg group&quot;</span>, pid);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// line 2251</span></span><br><span class="line"><span class="comment">// Utility routine to fork a process from the zygote.</span></span><br><span class="line">NO_STACK_PROTECTOR</span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">zygote::ForkCommon</span><span class="params">(JNIEnv* env, <span class="type">bool</span> is_system_server,</span></span><br><span class="line"><span class="params">                         <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&amp; fds_to_close,</span></span><br><span class="line"><span class="params">                         <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&amp; fds_to_ignore,</span></span><br><span class="line"><span class="params">                         <span class="type">bool</span> is_priority_fork,</span></span><br><span class="line"><span class="params">                         <span class="type">bool</span> purge)</span> &#123;</span><br><span class="line">  SetSignalHandlers();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Curry a failure function.</span></span><br><span class="line">  <span class="keyword">auto</span> fail_fn = <span class="built_in">std</span>::bind(zygote::ZygoteFailure, env,</span><br><span class="line">                           is_system_server ? <span class="string">&quot;system_server&quot;</span> : <span class="string">&quot;zygote&quot;</span>,</span><br><span class="line">                           nullptr, _1);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Temporarily block SIGCHLD during forks. The SIGCHLD handler might</span></span><br><span class="line">  <span class="comment">// log, which would result in the logging FDs we close being reopened.</span></span><br><span class="line">  <span class="comment">// This would cause failures because the FDs are not allowlisted.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Note that the zygote process is single threaded at this point.</span></span><br><span class="line">  BlockSignal(SIGCHLD, fail_fn);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Close any logging related FDs before we start evaluating the list of</span></span><br><span class="line">  <span class="comment">// file descriptors.</span></span><br><span class="line">  __android_log_close();</span><br><span class="line">  AStatsSocket_close();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If this is the first fork for this zygote, create the open FD table,</span></span><br><span class="line">  <span class="comment">// verifying that files are of supported type and allowlisted.  Otherwise (not</span></span><br><span class="line">  <span class="comment">// the first fork), check that the open files have not changed.  Newly open</span></span><br><span class="line">  <span class="comment">// files are not expected, and will be disallowed in the future.  Currently</span></span><br><span class="line">  <span class="comment">// they are allowed if they pass the same checks as in the</span></span><br><span class="line">  <span class="comment">// FileDescriptorTable::Create() above.</span></span><br><span class="line">  <span class="keyword">if</span> (gOpenFdTable == nullptr) &#123;</span><br><span class="line">    gOpenFdTable = FileDescriptorTable::Create(fds_to_ignore, fail_fn);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    gOpenFdTable-&gt;Restat(fds_to_ignore, fail_fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  android_fdsan_error_level fdsan_error_level = android_fdsan_get_error_level();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (purge) &#123;</span><br><span class="line">    <span class="comment">// Purge unused native memory in an attempt to reduce the amount of false</span></span><br><span class="line">    <span class="comment">// sharing with the child process.  By reducing the size of the libc_malloc</span></span><br><span class="line">    <span class="comment">// region shared with the child process we reduce the number of pages that</span></span><br><span class="line">    <span class="comment">// transition to the private-dirty state when malloc adjusts the meta-data</span></span><br><span class="line">    <span class="comment">// on each of the pages it is managing after the fork.</span></span><br><span class="line">    <span class="keyword">if</span> (mallopt(M_PURGE_ALL, <span class="number">0</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">      mallopt(M_PURGE, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">pid_t</span> pid = fork();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_priority_fork) &#123;</span><br><span class="line">      setpriority(PRIO_PROCESS, <span class="number">0</span>, PROCESS_PRIORITY_MAX);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setpriority(PRIO_PROCESS, <span class="number">0</span>, PROCESS_PRIORITY_MIN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__BIONIC__) &amp;&amp; !defined(NO_RESET_STACK_PROTECTOR)</span></span><br><span class="line">    <span class="comment">// Reset the stack guard for the new process.</span></span><br><span class="line">    android_reset_stack_guards();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The child process.</span></span><br><span class="line">    PreApplicationInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up any descriptors which must be closed immediately</span></span><br><span class="line">    DetachDescriptors(env, fds_to_close, fail_fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invalidate the entries in the USAP table.</span></span><br><span class="line">    ClearUsapTable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-open all remaining open file descriptors so that they aren&#x27;t shared</span></span><br><span class="line">    <span class="comment">// with the zygote across a fork.</span></span><br><span class="line">    gOpenFdTable-&gt;ReopenOrDetach(fail_fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turn fdsan back on.</span></span><br><span class="line">    android_fdsan_set_error_level(fdsan_error_level);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the fd to the unsolicited zygote socket</span></span><br><span class="line">    gSystemServerSocketFd = <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">    ALOGE(<span class="string">&quot;Failed to fork child process: %s (%d)&quot;</span>, strerror(errno), errno);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ALOGD(<span class="string">&quot;Forked child process %d&quot;</span>, pid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We blocked SIGCHLD prior to a fork, we unblock it here.</span></span><br><span class="line">  UnblockSignal(SIGCHLD, fail_fn);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This signal handler is for zygote mode, since the zygote must reap its children</span></span><br><span class="line">NO_STACK_PROTECTOR</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">SigChldHandler</span><span class="params">(<span class="type">int</span> <span class="comment">/*signal_number*/</span>, <span class="type">siginfo_t</span>* info, <span class="type">void</span>* <span class="comment">/*ucontext*/</span>)</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="type">int64_t</span> usaps_removed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It&#x27;s necessary to save and restore the errno during this function.</span></span><br><span class="line">    <span class="comment">// Since errno is stored per thread, changing it here modifies the errno</span></span><br><span class="line">    <span class="comment">// on the thread on which this signal handler executes. If a signal occurs</span></span><br><span class="line">    <span class="comment">// between a call and an errno check, it&#x27;s possible to get the errno set</span></span><br><span class="line">    <span class="comment">// here.</span></span><br><span class="line">    <span class="comment">// See b/23572286 for extra information.</span></span><br><span class="line">    <span class="type">int</span> saved_errno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Notify system_server that we received a SIGCHLD</span></span><br><span class="line">        sendSigChildStatus(pid, info-&gt;si_uid, status);</span><br><span class="line">        <span class="comment">// Log process-death status that we care about.</span></span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status)) &#123;</span><br><span class="line">            async_safe_format_log(ANDROID_LOG_INFO, LOG_TAG, <span class="string">&quot;Process %d exited cleanly (%d)&quot;</span>, pid,</span><br><span class="line">                                  WEXITSTATUS(status));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check to see if the PID is in the USAP pool and remove it if it is.</span></span><br><span class="line">            <span class="keyword">if</span> (RemoveUsapTableEntry(pid)) &#123;</span><br><span class="line">                ++usaps_removed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">            async_safe_format_log(ANDROID_LOG_INFO, LOG_TAG,</span><br><span class="line">                                  <span class="string">&quot;Process %d exited due to signal %d (%s)%s&quot;</span>, pid,</span><br><span class="line">                                  WTERMSIG(status), strsignal(WTERMSIG(status)),</span><br><span class="line">                                  WCOREDUMP(status) ? <span class="string">&quot;; core dumped&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the process exited due to a signal other than SIGTERM, check to see</span></span><br><span class="line">            <span class="comment">// if the PID is in the USAP pool and remove it if it is.  If the process</span></span><br><span class="line">            <span class="comment">// was closed by the Zygote using SIGTERM then the USAP pool entry will</span></span><br><span class="line">            <span class="comment">// have already been removed (see nativeEmptyUsapPool()).</span></span><br><span class="line">            <span class="keyword">if</span> (WTERMSIG(status) != SIGTERM &amp;&amp; RemoveUsapTableEntry(pid)) &#123;</span><br><span class="line">                ++usaps_removed;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the just-crashed process is the system_server, bring down zygote</span></span><br><span class="line">        <span class="comment">// so that it is restarted by init and system server will be restarted</span></span><br><span class="line">        <span class="comment">// from there.</span></span><br><span class="line">        <span class="keyword">if</span> (pid == gSystemServerPid) &#123;</span><br><span class="line">            async_safe_format_log(ANDROID_LOG_ERROR, LOG_TAG,</span><br><span class="line">                                  <span class="string">&quot;Exit zygote because system server (pid %d) has terminated&quot;</span>, pid);</span><br><span class="line">            kill(getpid(), SIGKILL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we shouldn&#x27;t consider ECHILD an error because</span></span><br><span class="line">    <span class="comment">// the secondary zygote might have no children left to wait for.</span></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span> &amp;&amp; errno != ECHILD) &#123;</span><br><span class="line">        async_safe_format_log(ANDROID_LOG_WARN, LOG_TAG, <span class="string">&quot;Zygote SIGCHLD error in waitpid: %s&quot;</span>,</span><br><span class="line">                              strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (usaps_removed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (TEMP_FAILURE_RETRY(write(gUsapPoolEventFD, &amp;usaps_removed, <span class="keyword">sizeof</span>(usaps_removed))) ==</span><br><span class="line">            <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// If this write fails something went terribly wrong.  We will now kill</span></span><br><span class="line">            <span class="comment">// the zygote and let the system bring it back up.</span></span><br><span class="line">            async_safe_format_log(ANDROID_LOG_ERROR, LOG_TAG,</span><br><span class="line">                                  <span class="string">&quot;Zygote failed to write to USAP pool event FD: %s&quot;</span>,</span><br><span class="line">                                  strerror(errno));</span><br><span class="line">            kill(getpid(), SIGKILL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errno = saved_errno;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// line 495</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Configures the SIGCHLD/SIGHUP handlers for the zygote process. This is</span></span><br><span class="line"><span class="comment">// configured very late, because earlier in the runtime we may fork() and</span></span><br><span class="line"><span class="comment">// exec() other processes, and we want to waitpid() for those rather than</span></span><br><span class="line"><span class="comment">// have them be harvested immediately.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Ignore SIGHUP because all processes forked by the zygote are in the same</span></span><br><span class="line"><span class="comment">// process group as the zygote and we don&#x27;t want to be notified if we become</span></span><br><span class="line"><span class="comment">// an orphaned group and have one or more stopped processes. This is not a</span></span><br><span class="line"><span class="comment">// theoretical concern :</span></span><br><span class="line"><span class="comment">// - we can become an orphaned group if one of our direct descendants forks</span></span><br><span class="line"><span class="comment">//   and is subsequently killed before its children.</span></span><br><span class="line"><span class="comment">// - crash_dump routinely STOPs the process it&#x27;s tracing.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// See issues b/71965619 and b/25567761 for further details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This ends up being called repeatedly before each fork(), but there&#x27;s</span></span><br><span class="line"><span class="comment">// no real harm in that.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">SetSignalHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig_chld</span> =</span> &#123;.sa_flags = SA_SIGINFO, .sa_sigaction = SigChldHandler&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigaction(SIGCHLD, &amp;sig_chld, nullptr) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;Error setting SIGCHLD handler: %s&quot;</span>, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sig_hup</span> =</span> &#123;&#125;;</span><br><span class="line">  sig_hup.sa_handler = SIG_IGN;</span><br><span class="line">  <span class="keyword">if</span> (sigaction(SIGHUP, &amp;sig_hup, nullptr) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ALOGW(<span class="string">&quot;Error setting SIGHUP handler: %s&quot;</span>, strerror(errno));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在Unix系统中，父进程必须用waitpid等待子进程的退出，否则子进程将变成Zombie僵尸进程，不仅系统资源泄露，而且系统将崩溃(没有System Server,所有的Andoid应用程序都无法运行)。但是waitpid()是一个阻塞函数(WNOHANG参数除外)，所以通常做法是在signal处理函数里进行无阻塞的处理，因为每个子进程的时候，系统会发出SIGCHID信号。Zygote会把自己杀掉，那父亲死了，所有的应用程序不就成了孤儿了？不会，因为父进程被杀掉系统会自动给所有的子进程发生SINGUP信号，该信号的默认处理就是杀掉自己退出当前进程。但是一些后台进程(Daemon)可以通过设置SIGING参数来忽略这个信号，从而得以在后台继续运行。</p>
<ul>
<li>总结</li>
</ul>
<ol>
<li>init 根据init.rc 运行app_process，并携带’-zygote‘和‘-startSystemServer’参数</li>
<li>AndroidRuntime.cpp::start()里将启动JavaVM，并且注册所有framework相关的系统JNI接口</li>
<li>运行ZygoteInit.java::main()函数初始化Zygote，Zygote并创建Socket的Server端</li>
<li>然后fork一个新的进程并在新进程里初始化SystemServer,Fork之前，Zygote是preload常用的Java类库，以及系统的resource,同时GC()清理内存空间，为子进程省去重复的工作。</li>
<li>SystemServer丽江所有的系统Service初始化，包括ActivityManager和WindowManager,它们是应用程序运行起来的前提</li>
<li>同时Zygote监听服务端Socket,等待新的应用启动请求</li>
<li>ActivityManager ready之后寻找系统的‘Startup’ Application，将请求发给Zygote</li>
<li>Zygote收到请求后，fork出一个新的进程</li>
<li>Zygote监听并处理SystemServer的SIGCHID信号，一旦System Server崩溃，立即将自己杀死。init会重启Zygote</li>
</ol>
<h3 id="fork函数"><a href="#fork函数" class="headerlink" title="fork函数"></a>fork函数</h3><ul>
<li>bionic&#x2F;libc&#x2F;bionic&#x2F;fork.cpp</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">	__fork_handler(<span class="number">-1</span>);</span><br><span class="line">	__block_app_sigs(&amp;<span class="built_in">set</span>);</span><br><span class="line">	<span class="type">int</span> need_locks = libc.need_locks &gt; <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (need_locks) &#123;</span><br><span class="line">		__ldso_atfork(<span class="number">-1</span>);</span><br><span class="line">		__inhibit_ptc();</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span> atfork_locks/<span class="keyword">sizeof</span> *atfork_locks; i++)</span><br><span class="line">			<span class="keyword">if</span> (*atfork_locks[i]) LOCK(*atfork_locks[i]);</span><br><span class="line">		__malloc_atfork(<span class="number">-1</span>);</span><br><span class="line">		__tl_lock();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">pthread_t</span> self=__pthread_self(), next=self-&gt;next;</span><br><span class="line">	<span class="type">pid_t</span> ret = _Fork();</span><br><span class="line">	<span class="type">int</span> errno_save = errno;</span><br><span class="line">	<span class="keyword">if</span> (need_locks) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">pthread_t</span> td=next; td!=self; td=td-&gt;next)</span><br><span class="line">				td-&gt;tid = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">if</span> (__vmlock_lockptr) &#123;</span><br><span class="line">				__vmlock_lockptr[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">				__vmlock_lockptr[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		__tl_unlock();</span><br><span class="line">		__malloc_atfork(!ret);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span> atfork_locks/<span class="keyword">sizeof</span> *atfork_locks; i++)</span><br><span class="line">			<span class="keyword">if</span> (*atfork_locks[i])</span><br><span class="line">				<span class="keyword">if</span> (ret) UNLOCK(*atfork_locks[i]);</span><br><span class="line">				<span class="keyword">else</span> **atfork_locks[i] = <span class="number">0</span>;</span><br><span class="line">		__release_ptc();</span><br><span class="line">		__ldso_atfork(!ret);</span><br><span class="line">	&#125;</span><br><span class="line">	__restore_sigs(&amp;<span class="built_in">set</span>);</span><br><span class="line">	__fork_handler(!ret);</span><br><span class="line">	<span class="keyword">if</span> (ret&lt;<span class="number">0</span>) errno = errno_save;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>不需要参数</li>
<li>需要的头文件&lt;sys&#x2F;types.h&gt; 和 &lt;unistd.h&gt;</li>
<li>返回值分两种情况：<ol>
<li>返回0表示成功创建子进程，并且接下来进入子进程执行流程</li>
<li>返回PID(&gt;0)，成功创建子进程，并且继续执行父进程流程代码</li>
<li>返回非正数(&lt;0)，创建子进程失败，失败的原因主要有进程数超过系统所能创建的上限，ENGAIN系统内存不足</li>
</ol>
</li>
</ol>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
    graph TB
    init[Initial process] --&gt; fork[Fork]
    fork -.Returns a new PID.-&gt; original[Original Process Continues]
    fork -.Returns zero .-&gt; new[New Process]
  </pre></div>

<p>&emsp;&emsp;使用fork()函数得到的子进程是父进程的一个复制品，它从父进程处继承了整个进程的地址空间：包括进程上下文(进程执行活动全过程的静态描述)、进程堆栈，打开的文件描述符、信号控制设定、进程优先级、进程组号等。子进程所独有的只有它的进程号，计时器等（只要少量信息）。因此，使用fork()函数的代价是很大的。</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ol>
<li>什么情况下Zygote进程会重启呢？</li>
</ol>
<ul>
<li>servicemanager进程被杀</li>
<li>(onresart)surfacelinger进程被杀</li>
<li>(onresart)Zygote进程自己被杀</li>
<li>(oneshot&#x3D;false)system_server进程被杀(waitpid)</li>
</ul>
<ol start="2">
<li>子进程与父进程的区别</li>
</ol>
<ul>
<li>除了文件锁以外，其他的锁都会被继承</li>
<li>各自的进程ID和父进程ID不同</li>
<li>子进程的未决告警被清除</li>
<li>子进程的未决信号集设置为空集</li>
</ul>
<ol start="3">
<li>写时拷贝(copy-on-write)</li>
</ol>
<p>&emsp;&emsp;Linux的fork()使用是通过写时拷贝(copy-on-write)实现。写时拷贝是一种可以推迟甚至避免拷贝数据的技术。内核此时并不复制地址空间，从而使各个进行拥有各自的地址空间。资源的复制是在需要写入的时候才会进行，在此之前，只有以读写方式共享</p>
<ol start="4">
<li>孤儿进程、僵尸进程</li>
</ol>
<p>&emsp;&emsp;fork系统调用之后，父子进程将交替执行，执行顺序不定。如果父进程先退出，子进程还没退出。那么子进程的父进程将变为init进程(托孤给了init进程)。(注：任何一个进程都必须有父进程)如果子进程先退出，父进程还没退出，那么子进程必须等到父进程捕获到了子进程的退出状态才真正结束，否则这个时候子进程就成为僵尸进程(只保留一些退出信息供父进程查询)</p>
<ol start="5">
<li>多线程进程的Fork调用</li>
</ol>
<p>&emsp;&emsp;在POSIX标准中，fork的行为是这样的：复制整个用户空间的数据(通常使用copy-on-write的策略，所以可以实现的速度很快)以及所有系统对象，然后仅复制当前线程到子线程。这里：所有父进程中别的线程，到了子进程中都是突然蒸发掉的。</p>
<p>&emsp;&emsp;假设这么一个环境，在fork之前，有一个子线程lock了某个锁，获得了对锁的所有权。fork以后，在子进程中，所有的额外线程都人间蒸发了。而锁却被正常复制了，在子进程看来，这个锁没有主人，所以没有任何人可以对它解锁。当子进程想unlock这个锁时，不再有任何手段可以解开。程序发生死锁。</p>
<h3 id="常见面试题"><a href="#常见面试题" class="headerlink" title="常见面试题"></a>常见面试题</h3><ol>
<li>你了解Android系统启动流程吗？</li>
</ol>
<p>&emsp;&emsp;当按下电源键触发开机，首先会从ROM中预定义的地方加载引导程序BootLoader到RAM中，并执行BootLoader程序启动Linux Kernel，然后启动用户级别的第一个进程:init进程。init进程会解析init.rc脚本做一些初始化工作，包括挂载文件系统、创建工作目录以及启动系统服务进程等，其中系统服务进程包括Zygote、service manager、media等。在Zygote中会进一步去启动system_server进程，然后在system_server进程中会启动AMS、WMS、PMS等服务，这些服务启动之后，AMS中就会打开Launcher应用的home Activity,最终就看到了手机的“桌面”</p>
<ol start="2">
<li>system_server为什么要在Zygote中启动，而不是由Init直接启动呢？</li>
</ol>
<p>&emsp;&emsp;Zygote作为一个孵化器，可以提前加载一些资源，这样fork()时基于Copy-On-Write机制创建的其他进程就能直接使用这些资源，而不用重新加载。比如system_server就可以直接使用Zygote中的JNI函数、共享库、常用类以及主题资源。</p>
<ol start="3">
<li>为什么要专门使用Zygote进程去孵化应用进程，而不是让system_server去孵化呢？</li>
</ol>
<p>&emsp;&emsp;首先system_server相比Zygote多运行了AMS、WMS等服务，对一些应用程序来说不是必需的。最重要的是进程的fork()对多线程不友好，只会将发起调用的线程拷贝到子进程，可能会导致死锁。</p>
<ol start="4">
<li>能说说具体是怎么导致死锁的吗？</li>
</ol>
<p>&emsp;&emsp;在POSIX标准中(可移植操作系统接口Portable Operating System Interface of UNIX)，fork的行为是这样的：复制整个用户空间的数据(通常使用copy-on-write的策略，所以可以实现的速度很快)以及所有系统对象，然后仅复制当前线程到子进程。这里：所有父进程中别的线程，到了子进程中都是突然蒸发掉的。对于锁来说，从OS看，每一个锁都有一个所有着，即最后一次lock它的线程。假设这么一个环境，在fork之前，有一个子线程lock了某个锁，获得了锁的所有权。fork以后，在子进程中，所有的额外线程都人间蒸发了。而锁却被正常复制了，在子进程看来，这个锁没有主任，所有没有任何人可以对它解锁。当子进程想lock这个锁时，不再有任何手段可以解开了。程序发生死锁</p>
<ol start="5">
<li>Zygote为什么不采用Binder机制进行IPC通信？</li>
</ol>
<p>&emsp;&emsp;Binder机制中存在Binder线程池，是多线程的，如果Zygote采用Binder的话存在fork()与多线程的问题。严格来说，Binder机制不一定要多线程，所谓的Binder线程只不过是在循环读取Binder驱动的消息而已，只注册一个Binder线程也是可以工作的，比如service manager就是这样的。实际上Zygote尽管没有采取Binder机制，它也不是单线程的，蛋挞在fork前主动停止了其他线程，fork后重新启动了。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://www.serendipity.fit">zj970</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.serendipity.fit/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">https://www.serendipity.fit/2023/12/13/Android-14-源码分析之启动流程/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://www.serendipity.fit" target="_blank">落雪のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></div><div class="post-share"><div class="social-share" data-image="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BActivityManagerService/" title="Android_14_源码分析之ActivityManagerService"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Android_14_源码分析之ActivityManagerService</div></div><div class="info-2"><div class="info-item-1"> 前序 一个人知道自己为什么而活，便能忍受任何一种生活      参考博客 厚雪长坡-ActivityTaskManagerService解析 LeeDuo-深入理解ActivityManagerService 芒果蒲公英-Android14 AMS启动流程 anly_jun-探索Activity之启动Intent Flag和taksAffinity menghaocheng-Android-AMS】ActivityManagerService启动分析 Sukai’s Blog  &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ ActivityManagerService&emsp;&emsp;Android系统非常庞大、错综复杂，其底层是采用Linux作为基底，上层采用包含虚拟机的Java层以及Native层，通过系统调用(Syscall)连接系统的内核空间与用户空间。用户空间主要采用C++和Java代码，通过JNI技术打通用户空间的Java层和Native层(C&#x2F;C++)。Google官方提...</div></div></div></a><a class="pagination-related" href="/2023/12/01/AndroidTV%E9%81%A5%E6%8E%A7%E4%BB%A5%E5%8F%8A%E5%8D%8F%E8%AE%AE%E6%B5%85%E6%9E%90/" title="AndroidTV遥控以及协议浅析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">AndroidTV遥控以及协议浅析</div></div><div class="info-2"><div class="info-item-1"> 前言 失之东隅，收之桑榆    参考文章 android 红外遥控器实现原理 Android红外及蓝牙遥控器适配流程  &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ 1. 海思红外遥控 adb 调试相关命令 cat &#x2F;proc&#x2F;bus&#x2F;input&#x2F;devices 查看input设备 dumpsys input 查看input设备 gatevent -l 查看输入event事件    1.1 遥控器逻辑过程以及源码分析 逻辑过程 从xml中获取物理键值，配对解析 linux的标准键值 自定义的字符串 定义这个字符串 android标准键值 android键值上报 按键事件处理    1.1.1 协议相关 涉及模块 device&#x2F;hisilicon&#x2F;bigfish&#x2F;sdk&#x2F;source&#x2F;msp&#x2F;drv&#x2F;ir&#x2F;ir_s2 device&#x2F;hisilicon&#x2F;bigfish...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BActivityManagerService/" title="Android_14_源码分析之ActivityManagerService"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-13</div><div class="info-item-2">Android_14_源码分析之ActivityManagerService</div></div><div class="info-2"><div class="info-item-1"> 前序 一个人知道自己为什么而活，便能忍受任何一种生活      参考博客 厚雪长坡-ActivityTaskManagerService解析 LeeDuo-深入理解ActivityManagerService 芒果蒲公英-Android14 AMS启动流程 anly_jun-探索Activity之启动Intent Flag和taksAffinity menghaocheng-Android-AMS】ActivityManagerService启动分析 Sukai’s Blog  &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ ActivityManagerService&emsp;&emsp;Android系统非常庞大、错综复杂，其底层是采用Linux作为基底，上层采用包含虚拟机的Java层以及Native层，通过系统调用(Syscall)连接系统的内核空间与用户空间。用户空间主要采用C++和Java代码，通过JNI技术打通用户空间的Java层和Native层(C&#x2F;C++)。Google官方提...</div></div></div></a><a class="pagination-related" href="/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BWindowManagerService/" title="Android_14_源码分析之WindowManagerService"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-13</div><div class="info-item-2">Android_14_源码分析之WindowManagerService</div></div><div class="info-2"><div class="info-item-1"> 前言    参考博客- &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ WindowManagerServiceActivity与Window相关概念 Activity只负责生命周期和事件处理 window只控制视图 一个Activity包含一个Window，如果Activity没有Window，那就相当于Service AMS统一调度所有应用程序的Activity WMS控制所有Window的显示与隐藏以及要显示的位置  Window&emsp;&emsp;“Window” 表明它是和窗口相关的，”窗口“是一个抽象的概念，从用户的角度来讲，它是一个”界面“;从SurfaceFlinger的角度来看，它是一个Layer,承载着和界面有关的数据和属性;从WMS角度来看，它是一个WindowState，用于管理和界面有关的状态。  表示一个窗口的概念，是所有View的直接管理者，任何视图都通过Window呈现(点击事件由Window-&gt;DecorView-&gt;View;Activity的setCo...</div></div></div></a><a class="pagination-related" href="/2023/12/13/Android-14-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BPackageManagerService/" title="Android_14_源码分析之PackageManagerService"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-13</div><div class="info-item-2">Android_14_源码分析之PackageManagerService</div></div><div class="info-2"><div class="info-item-1"> 前言 背负着过去的痛苦，夹杂着现实的烦恼，对人的心灵而言是无任何益处的      参考博客 wise丰 冬子  &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ PackageManagerService&emsp;&emsp;PackageManagerService(PMS)主要是管理应用的安装，卸载，更新，解析以及权限。同ActivityManagerService,PMS也是由SystemService孵化而来。   启动与初始化 frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java  12345678910111213141516171819202122232425262728//line 1234// Start the package manager.if (!mRuntimeRestart) &#123;    FrameworkStatsL...</div></div></div></a><a class="pagination-related" href="/2023/11/11/AndroidTv%E9%83%A8%E5%88%86%E9%A1%B5%E9%9D%A2%E6%8C%89%E9%94%AE%E9%9F%B3%E6%97%A0%E6%95%88/" title="AndroidTv部分页面按键音无效"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-11</div><div class="info-item-2">AndroidTv部分页面按键音无效</div></div><div class="info-2"><div class="info-item-1">  Android Tv 部分页面按键音无效，dispatchKeyEvent分发被拦截&emsp;&emsp;开始阅读之前，可以简单了解一下这些大佬的文章。    c枫_撸码的日子   Android 按键处理一 （基础知识） Android 按键处理二 （按键流程之内核层篇） Android 按键处理三 （按键流程之framework）   空杯的境界 Android 按键事件(KeyEvent)的分发机制   小羊子说 Android TV中按键事件和焦点处理总结   圆周率X Android dispatchKeyEvent事件分发详解，简单易懂    问题描述&emsp;&emsp;接入喇叭，进入应用，突然发现一些页面有系统调用的按键提示音，而有些页面则没有。(最终发现是使用了Scrollview出的bug) 问题分析&emsp;&emsp;既然按键声音没有发出，那首先需要了解一下按键声音是怎么发出的。当用户注册了clickListener，则调用发出playSoundEffect()和响应用户写好的onClick()方法。首先排除系统设置声音无效。可以使用adb命令 ...</div></div></div></a><a class="pagination-related" href="/2023/11/24/Android%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85-Java/" title="Android第三方网络框架封装-Java"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-24</div><div class="info-item-2">Android第三方网络框架封装-Java</div></div><div class="info-2"><div class="info-item-1">Android第三方网络框架封装-Java 参考文章&#x2F;博主 苏火火 Android进阶： 详解OkHttp+Retrofit+Rxjava实现网络请求 RxJava2+Retrofit2+OkHttp3的基础、封装和项目中的使用    &emsp;&emsp;本文中的所有内容大部分来源于网络资料，如有侵权请联系本人修改或删除，请大家多多支持原创!非常感谢！ 1. 概述&emsp;&emsp;在Android开发中，网络请求是必不可少的一环。最近做了一个需求，类似于应用宝的功能，需要从服务器获取数据，然后展示到界面上。并下载apk文件，实现静默安装。本篇主要介绍自己是如何使用Rxjava、Retrofit、Okhttp等框架，实现网络请求和下载apk的功能。 1.1 OKHttp&emsp;&emsp;OkHttp是一个用于处理HTTP请求的开源Java库，由Square公司开发。对于网络框架，更多的人会想到volley，volley是Android系统自带的网络请求框架。但是volle在Android 5.0之后被Google抛弃了，所以OkHttp逐渐成为Androi...</div></div></div></a><a class="pagination-related" href="/2025/09/20/ArchLinux-AOSP-0/" title="AOSP 环境搭建"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17553037581602176.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-20</div><div class="info-item-2">AOSP 环境搭建</div></div><div class="info-2"><div class="info-item-1"> 前言 心不死则道不生，欲不灭则道不存，心不苦则智慧不开，身不苦则福禄不厚。    AOSP 源码环境AOSP(Android Open Source Project)是适用于不同规格设备的操作系统。点击跳转官方文档 一、目录结构AOSP 是一个巨大的工程，下面是目录结构： 123456789101112131415161718192021222324252627282930313233343536aosp (Android Open Source Project)  |--- .repo            // 由 `repo` 工具管理的版本库元数据目录。包含一个清单文件 (.xml) 来定义如何组合数百个 Git 仓库以构建一个完整的 Android 系统。  |--- abi              // 应用二进制接口（ABI）检查相关工具和配置，用于确保二进制兼容性。  |--- art              // Android Runtime (ART) 源码。负责将 DEX 字节码编译成本地机器码并执行，是现代 Android 应用运行的核心虚拟机。 ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/zj970/resource/personal/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zj970</div><div class="author-info-description">谢谢你在世界的角落找到我</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zj970"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">外向是生活所需，孤独是自我享受</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E5%86%85%E6%A0%B8"><span class="toc-number">2.1.</span> <span class="toc-text">Linux 内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%9A%84%E5%A4%A7%E6%A6%82%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">Android 系统启动的大概流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init%E8%BF%9B%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">init进程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-rc-%E8%A7%A3%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">init.rc 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Action"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">Action</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Command"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">Command</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Options"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">Options</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">service解析流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zygote"><span class="toc-number">2.2.3.</span> <span class="toc-text">Zygote</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Zygote%E8%A7%A6%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">Zygote触发过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zygote%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">Zygote启动过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#System-Servver%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">System Servver启动流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fork%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.4.</span> <span class="toc-text">fork函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">2.2.5.</span> <span class="toc-text">其它</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">2.2.6.</span> <span class="toc-text">常见面试题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/20/ArchLinux-AOSP-0/" title="AOSP 环境搭建"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17553037581602176.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AOSP 环境搭建"/></a><div class="content"><a class="title" href="/2025/09/20/ArchLinux-AOSP-0/" title="AOSP 环境搭建">AOSP 环境搭建</a><time datetime="2025-09-20T14:41:49.000Z" title="发表于 2025-09-20 22:41:49">2025-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/14/ArchLinuxSunshine/" title="ArchLinuxSunshine"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17165170649320832.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ArchLinuxSunshine"/></a><div class="content"><a class="title" href="/2025/09/14/ArchLinuxSunshine/" title="ArchLinuxSunshine">ArchLinuxSunshine</a><time datetime="2025-09-13T17:55:33.000Z" title="发表于 2025-09-14 01:55:33">2025-09-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/04/Android%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86/" title="Android之渲染原理"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android之渲染原理"/></a><div class="content"><a class="title" href="/2025/06/04/Android%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86/" title="Android之渲染原理">Android之渲染原理</a><time datetime="2025-06-03T16:33:51.000Z" title="发表于 2025-06-04 00:33:51">2025-06-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/25/Debug-JDB/" title="Debug 工具之 JDB"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Debug 工具之 JDB"/></a><div class="content"><a class="title" href="/2025/05/25/Debug-JDB/" title="Debug 工具之 JDB">Debug 工具之 JDB</a><time datetime="2025-05-25T11:24:20.000Z" title="发表于 2025-05-25 19:24:20">2025-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/31/%E7%A6%BB%E5%88%AB2024/" title="离别2024"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/zhou-jian1234/resource/raw/master/paper/comics/17367140004646272.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="离别2024"/></a><div class="content"><a class="title" href="/2024/12/31/%E7%A6%BB%E5%88%AB2024/" title="离别2024">离别2024</a><time datetime="2024-12-31T15:59:59.000Z" title="发表于 2024-12-31 23:59:59">2024-12-31</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2025 By zj970</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>